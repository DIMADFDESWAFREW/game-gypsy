<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Gypsy Bottle Game</title>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        sans-serif;
      -webkit-user-select: none;
      user-select: none;
      touch-action: none;
    }

    #gameWrapper {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
    }

    #gameCanvas {
      width: 100%;
      height: 100%;
      display: block;
      background: #111;
      touch-action: none;
    }
  </style>
</head>
<body>
  <div id="gameWrapper">
    <canvas id="gameCanvas"></canvas>
  </div>

  <script>
    // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏—Ä–∞ ===
    const WORLD_WIDTH = 1536;   // —Ä–∞–∑–º–µ—Ä city-map.png
    const WORLD_HEIGHT = 1024;

    const GAME_DURATION = 30;   // —Å–µ–∫—É–Ω–¥

    // –ü—É—Ç–∏ –∫ —Ä–µ—Å—É—Ä—Å–∞–º (–∫–∞–∫ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)
    const MAP_SRC = "assets/city-map.png";
    const MASK_SRC = "assets/city-mask.png";   // —á/–± –º–∞—Å–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    const PLAYER_SRC = "assets/gypsy.png";
    const BOTTLE_SRC = "assets/bottle.png";

    // === –†–∞–±–æ—Ç–∞ —Å canvas ===
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // === –ö–∞–º–µ—Ä–∞ ===
    let cameraX = 0;
    let cameraY = 0;

    function updateCamera() {
      const vw = canvas.width / (window.devicePixelRatio || 1);
      const vh = canvas.height / (window.devicePixelRatio || 1);

      cameraX = player.x - vw / 2;
      cameraY = player.y - vh / 2;

      cameraX = Math.max(0, Math.min(WORLD_WIDTH - vw, cameraX));
      cameraY = Math.max(0, Math.min(WORLD_HEIGHT - vh, cameraY));
    }

    // === –ò–≥—Ä–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã ===
    const mapImg = new Image();
    const maskImg = new Image();
    const playerImg = new Image();
    const bottleImg = new Image();

    mapImg.src = MAP_SRC;
    maskImg.src = MASK_SRC;
    playerImg.src = PLAYER_SRC;
    bottleImg.src = BOTTLE_SRC;

    let assetsLoaded = 0;
    const TOTAL_ASSETS = 4;

    function onAssetLoad() {
      assetsLoaded++;
      if (assetsLoaded === TOTAL_ASSETS) {
        prepareMask();
        startGame();
      }
    }

    mapImg.onload = onAssetLoad;
    maskImg.onload = onAssetLoad;
    playerImg.onload = onAssetLoad;
    bottleImg.onload = onAssetLoad;

    // === –ú–∞—Å–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ===
    let maskCanvas, maskCtx, maskData, maskW, maskH, maskReady = false;

    function prepareMask() {
      maskCanvas = document.createElement("canvas");
      maskCanvas.width = maskImg.width;
      maskCanvas.height = maskImg.height;
      maskCtx = maskCanvas.getContext("2d");
      maskCtx.drawImage(maskImg, 0, 0);
      const imgData = maskCtx.getImageData(
        0,
        0,
        maskCanvas.width,
        maskCanvas.height
      );
      maskData = imgData.data;
      maskW = maskCanvas.width;
      maskH = maskCanvas.height;
      maskReady = true;
    }

    function isWalkable(x, y) {
      if (!maskReady) return true; // –ø–æ–∫–∞ –º–∞—Å–∫–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞ - –≤—Å—ë –ø—Ä–æ—Ö–æ–¥–∏–º–æ

      const ix = Math.floor(x);
      const iy = Math.floor(y);

      if (ix < 0 || iy < 0 || ix >= maskW || iy >= maskH) return false;

      const index = (iy * maskW + ix) * 4;
      const r = maskData[index];
      const g = maskData[index + 1];
      const b = maskData[index + 2];

      // –ë–µ–ª–æ–µ (–¥–æ—Ä–æ–≥–∏/—Ç—Ä–∞–≤–∞) => –ø—Ä–æ—Ö–æ–¥–∏–º–æ
      // –¢—ë–º–Ω–æ–µ (–¥–æ–º–∞/–æ–∑–µ—Ä–æ) => –Ω–µ–ø—Ä–æ—Ö–æ–¥–∏–º–æ
      const brightness = (r + g + b) / 3;
      return brightness > 200; // –ø–æ—Ä–æ–≥ –º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—å
    }

    // === –ò–≥—Ä–æ–∫ ===
    const player = {
      x: WORLD_WIDTH / 2,
      y: WORLD_HEIGHT / 2,
      speed: 160, // –ø–∏–∫—Å–µ–ª–µ–π –≤ —Å–µ–∫—É–Ω–¥—É
      dir: "down", // 'up' | 'down' | 'left' | 'right'
      animFrame: 0,
      animTimer: 0,
      animInterval: 0.12,
      size: 64, // –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    };

    let frameW = 0;
    let frameH = 0;

    function setupPlayerSprite() {
      // —Å–ø—Ä–∞–π—Ç 3—Ö3
      frameW = playerImg.width / 3;
      frameH = playerImg.height / 3;
    }

    // —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–µ –≤ —Å–ø—Ä–∞–π—Ç–µ
    function dirToRow(dir) {
      // –ø–æ–¥—Å—Ç—Ä–æ–µ–Ω–æ "–Ω–∞ –≥–ª–∞–∑" –ø–æ–¥ —Å–ø—Ä–∞–π—Ç:
      // 0-—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –≤–∏–¥ —Å–ø–µ—Ä–µ–¥–∏ (–≤–Ω–∏–∑)
      // 1-—è ‚Äî —Å–ø–∏–Ω–∞ (–≤–≤–µ—Ä—Ö)
      // 2-—è ‚Äî –±–æ–∫ (–¥–ª—è –ª–µ–≤–æ/–ø—Ä–∞–≤–æ)
      switch (dir) {
        case "down":
          return 0;
        case "up":
          return 1;
        case "left":
        case "right":
          return 2;
        default:
          return 0;
      }
    }

    // === –ë—É—Ç—ã–ª–∫–∏ ===
    const bottles = [];
    const MAX_BOTTLES = 10;
    const BOTTLE_RADIUS = 20;
    let score = 0;

    function randomSpawnPoint() {
      // –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –æ–Ω–∏ –ø—Ä–æ—Ö–æ–¥–∏–º—ã
      for (let i = 0; i < 200; i++) {
        const x = Math.random() * WORLD_WIDTH;
        const y = Math.random() * WORLD_HEIGHT;
        if (isWalkable(x, y)) {
          return { x, y };
        }
      }
      // fallback: —Ü–µ–Ω—Ç—Ä
      return { x: WORLD_WIDTH / 2, y: WORLD_HEIGHT / 2 };
    }

    function spawnBottle() {
      const p = randomSpawnPoint();
      bottles.push({ x: p.x, y: p.y, collected: false });
    }

    function ensureBottles() {
      while (bottles.length < MAX_BOTTLES) {
        spawnBottle();
      }
    }

    function updateBottleCollection() {
      for (const b of bottles) {
        if (b.collected) continue;
        const dx = b.x - player.x;
        const dy = b.y - player.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < 35) {
          b.collected = true;
          score++;
        }
      }
      // —É–¥–∞–ª—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –∏ –¥–æ—Å–ø–∞—É–Ω
      for (let i = bottles.length - 1; i >= 0; i--) {
        if (bottles[i].collected) bottles.splice(i, 1);
      }
      ensureBottles();
    }

    // === –î–∂–æ–π—Å—Ç–∏–∫ ===
    let joystickActive = false;
    let joystickId = null;
    let joyX = 0;
    let joyY = 0;

    const JOY_BASE_RADIUS = 90;
    const JOY_KNOB_RADIUS = 40;

    function getJoyBasePos() {
      const vw = canvas.width / (window.devicePixelRatio || 1);
      const vh = canvas.height / (window.devicePixelRatio || 1);
      return {
        x: vw / 2,
        y: vh - 120,
      };
    }

    function handlePointerDown(e) {
      const rect = canvas.getBoundingClientRect();
      const px = e.clientX - rect.left;
      const py = e.clientY - rect.top;
      const dpr = window.devicePixelRatio || 1;
      const x = px;
      const y = py;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫—É "–ò–≥—Ä–∞—Ç—å", –µ—Å–ª–∏ –∏–≥—Ä–∞ –µ—â—ë –Ω–µ –Ω–∞—á–∞—Ç–∞
      if (gameState === "ready") {
        if (isPointInPlayButton(x, y)) {
          startRound();
          return;
        }
      }

      const base = getJoyBasePos();
      const dx = x - base.x;
      const dy = y - base.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist <= JOY_BASE_RADIUS * 1.4) {
        joystickActive = true;
        joystickId = e.pointerId || "mouse";
        setJoystick(dx, dy);
      }
    }

    function handlePointerMove(e) {
      if (!joystickActive) return;
      if (joystickId !== (e.pointerId || "mouse")) return;

      const rect = canvas.getBoundingClientRect();
      const px = e.clientX - rect.left;
      const py = e.clientY - rect.top;
      const x = px;
      const y = py;

      const base = getJoyBasePos();
      const dx = x - base.x;
      const dy = y - base.y;
      setJoystick(dx, dy);
    }

    function handlePointerUp(e) {
      if (!joystickActive) return;
      if (joystickId !== (e.pointerId || "mouse")) return;
      joystickActive = false;
      joystickId = null;
      joyX = 0;
      joyY = 0;
    }

    function setJoystick(dx, dy) {
      const len = Math.sqrt(dx * dx + dy * dy);
      if (len < 10) {
        joyX = 0;
        joyY = 0;
        return;
      }
      const maxLen = JOY_BASE_RADIUS;
      const k = Math.min(len, maxLen) / len;
      joyX = dx * k / maxLen; // –Ω–æ—Ä–º–∏—Ä—É–µ–º –∫ [-1..1]
      joyY = dy * k / maxLen;
    }

    canvas.addEventListener("pointerdown", handlePointerDown);
    canvas.addEventListener("pointermove", handlePointerMove);
    canvas.addEventListener("pointerup", handlePointerUp);
    canvas.addEventListener("pointercancel", handlePointerUp);
    canvas.addEventListener("pointerout", handlePointerUp);
    canvas.addEventListener("pointerleave", handlePointerUp);

    // === –ò–≥—Ä–æ–≤–æ–π —Ç–∞–π–º–µ—Ä / —Å–æ—Å—Ç–æ—è–Ω–∏—è ===
    let gameState = "loading"; // 'loading' | 'ready' | 'running' | 'finished'
    let timeLeft = GAME_DURATION;
    let lastTs = 0;

    function startGame() {
      setupPlayerSprite();
      ensureBottles();
      gameState = "ready";
      lastTs = performance.now();
      requestAnimationFrame(loop);
    }

    function startRound() {
      score = 0;
      timeLeft = GAME_DURATION;
      bottles.length = 0;
      ensureBottles();
      gameState = "running";
    }

    // === –ö–Ω–æ–ø–∫–∞ "–ò–≥—Ä–∞—Ç—å 30 —Å–µ–∫" ===
    function getPlayButtonRect() {
      const vw = canvas.width / (window.devicePixelRatio || 1);
      const vh = canvas.height / (window.devicePixelRatio || 1);
      const w = 260;
      const h = 80;
      const x = (vw - w) / 2;
      const y = vh * 0.55;
      return { x, y, w, h };
    }

    function isPointInPlayButton(px, py) {
      const btn = getPlayButtonRect();
      return (
        px >= btn.x &&
        px <= btn.x + btn.w &&
        py >= btn.y &&
        py <= btn.y + btn.h
      );
    }

    // === –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª ===
    function loop(ts) {
      const dt = Math.min(0.05, (ts - lastTs) / 1000);
      lastTs = ts;

      if (gameState === "running") {
        timeLeft -= dt;
        if (timeLeft <= 0) {
          timeLeft = 0;
          gameState = "finished";
        }

        updatePlayer(dt);
        updateBottleCollection();
      }

      updateCamera();
      draw();

      requestAnimationFrame(loop);
    }

    function updatePlayer(dt) {
      // –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ –¥–∂–æ–π—Å—Ç–∏–∫—É
      let vx = joyX;
      let vy = joyY;
      const len = Math.sqrt(vx * vx + vy * vy);
      if (len > 0.01) {
        vx /= len;
        vy /= len;

        // –≤—ã–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        if (Math.abs(vx) > Math.abs(vy)) {
          player.dir = vx > 0 ? "right" : "left";
        } else {
          player.dir = vy > 0 ? "down" : "up";
        }

        const moveDist = player.speed * dt;
        const nx = player.x + vx * moveDist;
        const ny = player.y + vy * moveDist;

        // –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤ –Ω–æ–≤–æ–π —Ç–æ—á–∫–µ
        if (isWalkable(nx, ny)) {
          player.x = nx;
          player.y = ny;
        }

        // –∞–Ω–∏–º–∞—Ü–∏—è —à–∞–≥–∞
        player.animTimer += dt;
        if (player.animTimer >= player.animInterval) {
          player.animTimer = 0;
          player.animFrame = (player.animFrame + 1) % 3;
        }
      } else {
        // –Ω–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π –∫–∞–¥—Ä
        player.animFrame = 1;
        player.animTimer = 0;
      }
    }

    // === –û—Ç—Ä–∏—Å–æ–≤–∫–∞ ===
    function draw() {
      const vw = canvas.width / (window.devicePixelRatio || 1);
      const vh = canvas.height / (window.devicePixelRatio || 1);

      // —Ñ–æ–Ω
      ctx.clearRect(0, 0, vw, vh);

      // –∫–∞—Ä—Ç–∞
      if (mapImg.complete) {
        ctx.drawImage(
          mapImg,
          -cameraX,
          -cameraY,
          WORLD_WIDTH,
          WORLD_HEIGHT
        );
      }

      // –±—É—Ç—ã–ª–∫–∏
      if (bottleImg.complete) {
        for (const b of bottles) {
          const sx = b.x - cameraX;
          const sy = b.y - cameraY;
          const size = 32;
          ctx.drawImage(
            bottleImg,
            sx - size / 2,
            sy - size,
            size,
            size
          );
        }
      }

      // –∏–≥—Ä–æ–∫
      if (playerImg.complete) {
        const row = dirToRow(player.dir);
        let col = player.animFrame;

        const sx = col * frameW;
        const sy = row * frameH;

        const screenX = player.x - cameraX;
        const screenY = player.y - cameraY;

        ctx.save();

        // –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è –≤–ª–µ–≤–æ ‚Äî —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–æ X
        if (player.dir === "left") {
          ctx.translate(screenX, screenY);
          ctx.scale(-1, 1);
          ctx.translate(-screenX, -screenY);
        }

        const drawSize = player.size;
        ctx.drawImage(
          playerImg,
          sx,
          sy,
          frameW,
          frameH,
          screenX - drawSize / 2,
          screenY - drawSize * 0.9,
          drawSize,
          drawSize * 1.4
        );

        ctx.restore();
      }

      // HUD (—Ç–∞–π–º–µ—Ä –∏ —Å—á—ë—Ç)
      ctx.save();
      ctx.fillStyle = "#fff";
      ctx.font = "22px -apple-system, system-ui, sans-serif";
      ctx.textBaseline = "top";

      const timeText = `${Math.ceil(timeLeft)} s`;
      const scoreText = `${score}`;

      ctx.fillText(timeText, 16, 10);
      ctx.fillText("üçæ " + scoreText, 16 + ctx.measureText(timeText).width + 12, 10);
      ctx.restore();

      // —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–ì–æ—Ç–æ–≤–æ" / "–§–∏–Ω–∏—à"
      if (gameState === "ready" || gameState === "finished") {
        drawPlayButton(vw, vh);
      }

      // –¥–∂–æ–π—Å—Ç–∏–∫
      drawJoystick(vw, vh);
    }

    function drawPlayButton(vw, vh) {
      const btn = getPlayButtonRect();

      ctx.save();
      // —Ç–µ–Ω—å
      ctx.beginPath();
      ctx.roundRect(btn.x, btn.y + 8, btn.w, btn.h, 40);
      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.fill();

      // –æ—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
      const grad = ctx.createLinearGradient(btn.x, btn.y, btn.x + btn.w, btn.y + btn.h);
      grad.addColorStop(0, "#ffb13b");
      grad.addColorStop(1, "#ff8b00");

      ctx.beginPath();
      ctx.roundRect(btn.x, btn.y, btn.w, btn.h, 40);
      ctx.fillStyle = grad;
      ctx.fill();

      ctx.fillStyle = "#fff";
      ctx.font = "24px -apple-system, system-ui, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      const label =
        gameState === "finished"
          ? "–ò–≥—Ä–∞—Ç—å –µ—â—ë 30 —Å–µ–∫"
          : "–ò–≥—Ä–∞—Ç—å 30 —Å–µ–∫";
      ctx.fillText(label, btn.x + btn.w / 2, btn.y + btn.h / 2);
      ctx.restore();
    }

    function drawJoystick(vw, vh) {
      const base = getJoyBasePos();

      ctx.save();
      ctx.globalAlpha = 0.95;

      // –≤–Ω–µ—à–Ω—è—è —Ç–µ–Ω—å
      ctx.beginPath();
      ctx.arc(base.x, base.y, JOY_BASE_RADIUS + 18, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(0,0,0,0.8)";
      ctx.fill();

      // –æ—Å–Ω–æ–≤–∞
      const gradBase = ctx.createRadialGradient(
        base.x,
        base.y,
        10,
        base.x,
        base.y,
        JOY_BASE_RADIUS
      );
      gradBase.addColorStop(0, "#3b3b3b");
      gradBase.addColorStop(1, "#050505");

      ctx.beginPath();
      ctx.arc(base.x, base.y, JOY_BASE_RADIUS, 0, Math.PI * 2);
      ctx.fillStyle = gradBase;
      ctx.fill();

      // —Ä—É—á–∫–∞ –¥–∂–æ–π—Å—Ç–∏–∫–∞
      const knobOffset = {
        x: joyX * JOY_BASE_RADIUS,
        y: joyY * JOY_BASE_RADIUS,
      };
      const kx = base.x + knobOffset.x;
      const ky = base.y + knobOffset.y;

      const gradKnob = ctx.createRadialGradient(kx, ky, 5, kx, ky, JOY_KNOB_RADIUS);
      gradKnob.addColorStop(0, "#ffd66b");
      gradKnob.addColorStop(1, "#ff9a00");

      ctx.beginPath();
      ctx.arc(kx, ky, JOY_KNOB_RADIUS, 0, Math.PI * 2);
      ctx.fillStyle = gradKnob;
      ctx.fill();

      ctx.restore();
    }

    // polyfill roundRect –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
    if (!CanvasRenderingContext2D.prototype.roundRect) {
      CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
        if (w < 2 * r) r = w / 2;
        if (h < 2 * r) r = h / 2;
        this.beginPath();
        this.moveTo(x + r, y);
        this.arcTo(x + w, y, x + w, y + h, r);
        this.arcTo(x + w, y + h, x, y + h, r);
        this.arcTo(x, y + h, x, y, r);
        this.arcTo(x, y, x + w, y, r);
        this.closePath();
        return this;
      };
    }
  </script>
</body>
</html>