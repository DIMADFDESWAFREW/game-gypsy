
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Gypsy Bottle Hunt</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<style>
  body {
    margin: 0;
    background: #000;
    overflow: hidden;
    touch-action: none;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  #game {
    width: 100vw;
    height: 100vh;
    display: block;
    background: #c7a96b;
  }
  .hud {
    position: fixed;
    top: 10px;
    left: 10px;
    color: #fff;
    font-size: 16px;
    text-shadow: 0 0 4px #000;
    z-index: 10;
  }
  .hud div { margin-bottom: 4px; }

  .joy {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.4);
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25), rgba(0,0,0,0.3));
    z-index: 10;
  }
  .joy-inner {
    position: absolute;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.85);
    left: 36px;
    top: 36px;
    transform: translateZ(0);
  }

  @media (min-width: 900px) {
    .joy { bottom: 40px; left: 40px; }
  }
</style>
</head>
<body>
<canvas id="game"></canvas>

<div class="hud">
  <div>Счёт: <span id="score">0</span></div>
  <div>Время: <span id="time">120</span> c</div>
</div>

<div class="joy">
  <div class="joy-inner" id="stick"></div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

// HUD
const scoreEl = document.getElementById("score");
const timeEl  = document.getElementById("time");

// World
const WORLD_W = 5000;
const WORLD_H = 5000;

// Assets
const gypsyImg = new Image();
gypsyImg.src = "assets/gypsy.png";

const bottleImg = new Image();
bottleImg.src = "assets/bottle.png";

// Player
const player = {
  x: WORLD_W / 2,
  y: WORLD_H / 2,
  speed: 0.26,
};

// Animation
const frameW = 64;
const frameH = 64;
let frame = 0;
let frameTimer = 0;
let dir = 0; // 0-down,1-up,2-left,3-right

// Controls
let joyDX = 0, joyDY = 0;
const joy = document.querySelector(".joy");
const stick = document.getElementById("stick");
let joyActive = false;

function handleJoyTouch(e) {
  const rect = joy.getBoundingClientRect();
  const t = e.touches[0];
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + rect.height / 2;
  const x = t.clientX - cx;
  const y = t.clientY - cy;
  const dist = Math.hypot(x, y);
  const max = rect.width * 0.4;
  if (dist < 4) {
    joyDX = joyDY = 0;
    stick.style.left = "36px";
    stick.style.top  = "36px";
    return;
  }
  const nx = x / dist;
  const ny = y / dist;
  const cl = Math.min(dist, max);
  joyDX = nx * (cl / max);
  joyDY = ny * (cl / max);
  stick.style.left = (36 + joyDX * 30) + "px";
  stick.style.top  = (36 + joyDY * 30) + "px";
}

joy.addEventListener("touchstart", e => {
  joyActive = true;
  handleJoyTouch(e);
}, {passive:false});

joy.addEventListener("touchmove", e => {
  e.preventDefault();
  if (!joyActive) return;
  handleJoyTouch(e);
}, {passive:false});

joy.addEventListener("touchend", e => {
  joyActive = false;
  joyDX = joyDY = 0;
  stick.style.left = "36px";
  stick.style.top  = "36px";
}, {passive:false});

joy.addEventListener("touchcancel", e => {
  joyActive = false;
  joyDX = joyDY = 0;
  stick.style.left = "36px";
  stick.style.top  = "36px";
}, {passive:false});

// Keyboard
const keys = {ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false};
document.addEventListener("keydown", e => {
  if (e.key in keys) keys[e.key] = true;
});
document.addEventListener("keyup", e => {
  if (e.key in keys) keys[e.key] = false;
});

// Bottles
let bottles = [];
let lastSpawn = 0;
const BOTTLE_LIFETIME = 5000;
const SPAWN_INTERVAL = 900;

// Game
let score = 0;
let timeLeft = 120000;
let lastTime = performance.now();
let gameOver = false;

function spawnBottle() {
  bottles.push({
    x: 100 + Math.random() * (WORLD_W - 200),
    y: 100 + Math.random() * (WORLD_H - 200),
    spawn: performance.now()
  });
}

function update(dt, now) {
  if (gameOver) return;

  // Timer
  timeLeft -= dt;
  if (timeLeft <= 0) {
    timeLeft = 0;
    gameOver = true;
  }
  timeEl.textContent = (timeLeft / 1000 | 0).toString();

  // Spawn bottles
  if (now - lastSpawn > SPAWN_INTERVAL) {
    spawnBottle();
    lastSpawn = now;
  }

  // Movement
  let mx = joyDX;
  let my = joyDY;

  if (!joyActive) {
    if (keys.ArrowUp)    my -= 1;
    if (keys.ArrowDown)  my += 1;
    if (keys.ArrowLeft)  mx -= 1;
    if (keys.ArrowRight) mx += 1;
  }

  if (mx !== 0 || my !== 0) {
    const len = Math.hypot(mx, my);
    mx /= len;
    my /= len;

    player.x += mx * player.speed * dt;
    player.y += my * player.speed * dt;

    if (Math.abs(mx) > Math.abs(my)) {
      dir = mx > 0 ? 3 : 2;
    } else {
      dir = my > 0 ? 0 : 1;
    }

    frameTimer += dt;
    if (frameTimer > 120) {
      frame = (frame + 1) % 3;
      frameTimer = 0;
    }
  } else {
    frame = 1;
  }

  player.x = Math.min(Math.max(player.x, 30), WORLD_W - 30);
  player.y = Math.min(Math.max(player.y, 30), WORLD_H - 30);

  bottles = bottles.filter(b => {
    if (now - b.spawn > BOTTLE_LIFETIME) return false;
    const dist = Math.hypot(player.x - b.x, player.y - b.y);
    if (dist < 45) {
      score++;
      scoreEl.textContent = score.toString();
      return false;
    }
    return true;
  });
}

function draw(now) {
  ctx.fillStyle = "#c7a96b";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const camX = player.x - canvas.width / 2;
  const camY = player.y - canvas.height / 2;

  ctx.save();
  ctx.translate(-camX, -camY);

  bottles.forEach(b => {
    const w = bottleImg.width;
    const h = bottleImg.height;
    ctx.drawImage(bottleImg, b.x - w/2, b.y - h + 20);
  });

  if (gypsyImg.complete) {
    ctx.drawImage(
      gypsyImg,
      frame * frameW,
      dir * frameH,
      frameW, frameH,
      player.x - frameW / 2,
      player.y - frameH / 2,
      frameW, frameH
    );
  } else {
    ctx.fillStyle = "white";
    ctx.beginPath();
    ctx.arc(player.x, player.y, 20, 0, Math.PI * 2);
    ctx.fill();
  }

  ctx.restore();

  if (gameOver) {
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#fff";
    ctx.font = "28px system-ui";
    ctx.textAlign = "center";
    ctx.fillText("Игра окончена", canvas.width/2, canvas.height/2 - 10);
    ctx.font = "22px system-ui";
    ctx.fillText("Собрано бутылок: " + score, canvas.width/2, canvas.height/2 + 24);
  }
}

function loop(now) {
  const dt = now - lastTime;
  lastTime = now;
  update(dt, now);
  draw(now);
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
