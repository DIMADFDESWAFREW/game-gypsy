<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Gypsy Bottle Game ‚Äî City Map</title>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      -webkit-user-select: none;
      user-select: none;
      touch-action: none;
    }

    #gameWrapper {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
    }

    #gameCanvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
      background: #111;
      touch-action: none;
    }

    /* HUD: —Ç–∞–π–º–µ—Ä + —Å—á—ë—Ç */
    #hud {
      position: absolute;
      top: 8px;
      left: 10px;
      right: 10px;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
      color: #fff;
      font-size: 18px;
      text-shadow: 0 0 4px #000;
    }

    #timer {
      font-weight: 600;
    }

    #score {
      font-weight: 600;
    }

    /* –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ä—Ç–∞ */
    #startOverlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 20;
      background: radial-gradient(circle at center, #222 0, #000 60%);
    }

    #startButton {
      padding: 16px 40px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #ffb739, #ff7f00);
      color: #fff;
      font-size: 22px;
      font-weight: 700;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
      cursor: pointer;
    }

    #startButton:active {
      transform: translateY(1px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
    }

    #message {
      margin-top: 16px;
      color: #fff;
      font-size: 16px;
      text-align: center;
      max-width: 90%;
      text-shadow: 0 0 4px #000;
    }

    /* –î–∂–æ–π—Å—Ç–∏–∫ */
    #joystick {
      position: absolute;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: radial-gradient(circle at center, #444 0, #111 65%, #000 100%);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 15;
      touch-action: none;
    }

    #joystickKnob {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffd76a 0, #ffb739 35%, #ff8a00 100%);
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.9);
      touch-action: none;
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º –¥–∂–æ–π—Å—Ç–∏–∫, –∫–æ–≥–¥–∞ –∏–≥—Ä–∞ –Ω–µ –∏–¥—ë—Ç */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div id="gameWrapper">
    <canvas id="gameCanvas"></canvas>

    <div id="hud">
      <div id="timer">30 s</div>
      <div id="score">üçæ 0</div>
    </div>

    <div id="startOverlay">
      <button id="startButton">–ò–≥—Ä–∞—Ç—å 30 —Å–µ–∫</button>
      <div id="message">–°–æ–±–µ—Ä–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –±—É—Ç—ã–ª–æ–∫ –∑–∞ 30 —Å–µ–∫—É–Ω–¥</div>
    </div>

    <div id="joystick" class="hidden">
      <div id="joystickKnob"></div>
    </div>
  </div>

  <script>
    // ==== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–≥—Ä—ã ====
    const GAME_DURATION = 30; // —Å–µ–∫—É–Ω–¥
    const PLAYER_SPEED = 180; // –ø–∏–∫—Å–µ–ª–µ–π –≤ —Å–µ–∫—É–Ω–¥—É
    const PLAYER_RADIUS = 26;
    const BOTTLE_RADIUS = 18;
    const BOTTLE_COUNT = 10;
    const FRAME_DURATION = 0.12; // —Å–µ–∫ –Ω–∞ –∫–∞–¥—Ä –∞–Ω–∏–º–∞—Ü–∏–∏

    // —Å–ø—Ä–∞–π—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    const SPRITE_COLS = 3;
    const SPRITE_ROWS = 3;
    const DIR_DOWN = 0;
    const DIR_LEFT = 1;
    const DIR_RIGHT = 2;
    const DIR_UP = 3; // –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "—Å–ø–∏–Ω—É" –∏–∑ –≤–µ—Ä—Ö–Ω–µ–≥–æ —Ä—è–¥–∞

    // ==== DOM-—ç–ª–µ–º–µ–Ω—Ç—ã ====
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const hudTimer = document.getElementById("timer");
    const hudScore = document.getElementById("score");
    const startOverlay = document.getElementById("startOverlay");
    const startButton = document.getElementById("startButton");
    const messageBox = document.getElementById("message");

    const joystick = document.getElementById("joystick");
    const joystickKnob = document.getElementById("joystickKnob");

    // ==== –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ====
    let canvasWidth = 0;
    let canvasHeight = 0;

    let mapImg = new Image();
    let bottleImg = new Image();
    let playerImg = new Image();
    let obstacleTopImg = new Image();
    let obstacleBottomImg = new Image();

    let assetsLoaded = 0;
    const TOTAL_ASSETS = 5;

    let mapReady = false;
    let worldWidth = 0;
    let worldHeight = 0;

    const player = {
      x: 0,
      y: 0,
      dir: DIR_DOWN,
      frameIndex: 0,
      frameTimer: 0,
      frameW: 0,
      frameH: 0,
    };

    let bottles = [];
    let score = 0;
    let timeLeft = GAME_DURATION;
    let isRunning = false;

    // –∫–∞–º–µ—Ä–∞
    const camera = {
      x: 0,
      y: 0,
    };

    // –¥–∂–æ–π—Å—Ç–∏–∫
    const joystickState = {
      active: false,
      centerX: 0,
      centerY: 0,
      dx: 0,
      dy: 0,
    };

    // ==== –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Å—Å–µ—Ç–æ–≤ ====
    function assetLoaded() {
      assetsLoaded++;
      if (assetsLoaded >= TOTAL_ASSETS) {
        setupWorld();
      }
    }

    mapImg.src = "assets/city-map.png";
    mapImg.onload = function () {
      mapReady = true;
      assetLoaded();
    };

    bottleImg.src = "assets/bottle.png";
    bottleImg.onload = assetLoaded;

    playerImg.src = "assets/gypsy.png";
    playerImg.onload = function () {
      player.frameW = playerImg.width / SPRITE_COLS;
      player.frameH = playerImg.height / SPRITE_ROWS;
      assetLoaded();
    };

    obstacleTopImg.src = "assets/obstacle_top.png";
    obstacleTopImg.onload = assetLoaded;

    obstacleBottomImg.src = "assets/obstacle_bottom.png";
    obstacleBottomImg.onload = assetLoaded;

    // ==== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏—Ä–∞ ====
    function setupWorld() {
      // —Ä–∞–∑–º–µ—Ä –º–∏—Ä–∞ = —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã
      worldWidth = mapImg.width;
      worldHeight = mapImg.height;

      // —Å—Ç–∞–≤–∏–º –∏–≥—Ä–æ–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã
      player.x = worldWidth / 2;
      player.y = worldHeight / 2;

      spawnBottles();

      resizeCanvas();
      updateHUD();
    }

    function spawnBottles() {
      bottles = [];
      for (let i = 0; i < BOTTLE_COUNT; i++) {
        const margin = 80;
        const x = margin + Math.random() * (worldWidth - margin * 2);
        const y = margin + Math.random() * (worldHeight - margin * 2);
        bottles.push({ x, y, collected: false });
      }
    }

    // ==== –†–∞–∑–º–µ—Ä canvas ====
    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvasWidth = rect.width;
      canvasHeight = rect.height;

      // —É—á–∏—Ç—ã–≤–∞–µ–º DPR –¥–ª—è —á—ë—Ç–∫–æ—Å—Ç–∏
      const dpr = window.devicePixelRatio || 1;
      canvas.width = canvasWidth * dpr;
      canvas.height = canvasHeight * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    window.addEventListener("resize", resizeCanvas);

    // ==== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∂–æ–π—Å—Ç–∏–∫–æ–º ====
    function getJoystickRect() {
      return joystick.getBoundingClientRect();
    }

    function pointerDown(e) {
      e.preventDefault();
      const rect = getJoystickRect();
      const touch = e.touches ? e.touches[0] : e;
      const x = touch.clientX;
      const y = touch.clientY;

      joystickState.active = true;
      joystickState.centerX = rect.left + rect.width / 2;
      joystickState.centerY = rect.top + rect.height / 2;

      updateJoystickVector(x, y);
    }

    function pointerMove(e) {
      if (!joystickState.active) return;
      e.preventDefault();
      const touch = e.touches ? e.touches[0] : e;
      updateJoystickVector(touch.clientX, touch.clientY);
    }

    function pointerUp(e) {
      if (!joystickState.active) return;
      e.preventDefault();
      joystickState.active = false;
      joystickState.dx = 0;
      joystickState.dy = 0;
      joystickKnob.style.transform = "translate(0px, 0px)";
    }

    function updateJoystickVector(x, y) {
      const dx = x - joystickState.centerX;
      const dy = y - joystickState.centerY;

      const maxDist = getJoystickRect().width / 2 - 20;
      let dist = Math.sqrt(dx * dx + dy * dy);
      let nx = 0;
      let ny = 0;

      if (dist > 0) {
        const k = Math.min(dist, maxDist) / dist;
        nx = dx * k;
        ny = dy * k;
        joystickKnob.style.transform = `translate(${nx}px, ${ny}px)`;

        // –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –≤–µ–∫—Ç–æ—Ä [-1,1]
        joystickState.dx = dx / maxDist;
        joystickState.dy = dy / maxDist;
        // –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ –¥–ª–∏–Ω–µ
        const len = Math.sqrt(
          joystickState.dx * joystickState.dx +
            joystickState.dy * joystickState.dy
        );
        if (len > 1) {
          joystickState.dx /= len;
          joystickState.dy /= len;
        }
      } else {
        joystickState.dx = 0;
        joystickState.dy = 0;
      }
    }

    joystick.addEventListener("touchstart", pointerDown, { passive: false });
    joystick.addEventListener("touchmove", pointerMove, { passive: false });
    joystick.addEventListener("touchend", pointerUp, { passive: false });
    joystick.addEventListener("touchcancel", pointerUp, { passive: false });

    joystick.addEventListener("mousedown", pointerDown);
    window.addEventListener("mousemove", pointerMove);
    window.addEventListener("mouseup", pointerUp);

    // ==== –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã ====
    function startGame() {
      if (!mapReady || assetsLoaded < TOTAL_ASSETS) {
        messageBox.textContent = "–ï—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É‚Ä¶";
        return;
      }
      isRunning = true;
      timeLeft = GAME_DURATION;
      score = 0;
      spawnBottles();
      updateHUD();

      startOverlay.classList.add("hidden");
      joystick.classList.remove("hidden");
    }

    function endGame() {
      isRunning = false;
      joystick.classList.add("hidden");
      startOverlay.classList.remove("hidden");
      messageBox.textContent = `–í—Ä–µ–º—è –≤—ã—à–ª–æ! –¢—ã —Å–æ–±—Ä–∞–ª ${score} –±—É—Ç—ã–ª–æ–∫ üçæ`;
    }

    function updateHUD() {
      hudTimer.textContent = `${Math.ceil(timeLeft)} s`;
      hudScore.textContent = `üçæ ${score}`;
    }

    startButton.addEventListener("click", startGame);

    // ==== –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª ====
    let lastTs = 0;

    function loop(ts) {
      if (!lastTs) lastTs = ts;
      const dt = (ts - lastTs) / 1000;
      lastTs = ts;

      update(dt);
      draw();

      requestAnimationFrame(loop);
    }

    function update(dt) {
      if (!mapReady || assetsLoaded < TOTAL_ASSETS) return;

      if (isRunning) {
        timeLeft -= dt;
        if (timeLeft <= 0) {
          timeLeft = 0;
          updateHUD();
          endGame();
          return;
        }

        const moveX = joystickState.dx;
        const moveY = joystickState.dy;
        const len = Math.sqrt(moveX * moveX + moveY * moveY);

        if (len > 0.05) {
          const vx = (moveX / len) * PLAYER_SPEED;
          const vy = (moveY / len) * PLAYER_SPEED;

          player.x += vx * dt;
          player.y += vy * dt;

          // –Ω–µ –≤—ã—Ö–æ–¥–∏–º –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∫–∞—Ä—Ç—ã
          player.x = Math.max(PLAYER_RADIUS, Math.min(worldWidth - PLAYER_RADIUS, player.x));
          player.y = Math.max(PLAYER_RADIUS, Math.min(worldHeight - PLAYER_RADIUS, player.y));

          // –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
          const angle = Math.atan2(vy, vx); // -PI..PI
          if (Math.abs(vx) > Math.abs(vy)) {
            player.dir = vx > 0 ? DIR_RIGHT : DIR_LEFT;
          } else {
            player.dir = vy > 0 ? DIR_DOWN : DIR_UP;
          }

          // –æ–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
          player.frameTimer += dt;
          if (player.frameTimer >= FRAME_DURATION) {
            player.frameTimer = 0;
            player.frameIndex = (player.frameIndex + 1) % SPRITE_COLS;
          }
        } else {
          // —Å—Ç–æ–∏–º ‚Äî –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä
          player.frameIndex = 0;
          player.frameTimer = 0;
        }

        // —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –±—É—Ç—ã–ª–∫–∞–º–∏
        for (const b of bottles) {
          if (b.collected) continue;
          const dx = b.x - player.x;
          const dy = b.y - player.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < PLAYER_RADIUS + BOTTLE_RADIUS) {
            b.collected = true;
            score++;
            updateHUD();
          }
        }

        updateHUD();
      }

      // –∫–∞–º–µ—Ä–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º
      const halfW = canvasWidth / 2;
      const halfH = canvasHeight / 2;
      camera.x = player.x - halfW;
      camera.y = player.y - halfH;

      // –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –º–∏—Ä–∞
      camera.x = Math.max(0, Math.min(worldWidth - canvasWidth, camera.x));
      camera.y = Math.max(0, Math.min(worldHeight - canvasHeight, camera.y));
    }

    function draw() {
      ctx.clearRect(0, 0, canvasWidth, canvasHeight);

      if (!mapReady || assetsLoaded < TOTAL_ASSETS) {
        ctx.fillStyle = "#fff";
        ctx.font = "16px system-ui";
        ctx.textAlign = "center";
        ctx.fillText("–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶", canvasWidth / 2, canvasHeight / 2);
        return;
      }

      // —Ä–∏—Å—É–µ–º –∫–∞—Ä—Ç—É —Å —É—á—ë—Ç–æ–º –∫–∞–º–µ—Ä—ã
      ctx.drawImage(
        mapImg,
        camera.x,
        camera.y,
        canvasWidth,
        canvasHeight,
        0,
        0,
        canvasWidth,
        canvasHeight
      );

      // –±—É—Ç—ã–ª–∫–∏
      for (const b of bottles) {
        if (b.collected) continue;
        const screenX = b.x - camera.x;
        const screenY = b.y - camera.y;
        ctx.drawImage(
          bottleImg,
          screenX - BOTTLE_RADIUS,
          screenY - BOTTLE_RADIUS,
          BOTTLE_RADIUS * 2,
          BOTTLE_RADIUS * 2
        );
      }

      // –ø–µ—Ä—Å–æ–Ω–∞–∂
      const screenPX = player.x - camera.x;
      const screenPY = player.y - camera.y;

      let row;
      switch (player.dir) {
        case DIR_LEFT:
          row = 1;
          break;
        case DIR_RIGHT:
          row = 2;
          break;
        case DIR_UP:
          row = 0; // –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ä—Ö–Ω–∏–π —Ä—è–¥ –∫–∞–∫ "—Å–ø–∏–Ω—É"
          break;
        case DIR_DOWN:
        default:
          row = 0;
          break;
      }

      const sx = player.frameIndex * player.frameW;
      const sy = row * player.frameH;

      const drawW = PLAYER_RADIUS * 2.2;
      const drawH = (player.frameH / player.frameW) * drawW;

      ctx.drawImage(
        playerImg,
        sx,
        sy,
        player.frameW,
        player.frameH,
        screenPX - drawW / 2,
        screenPY - drawH + PLAYER_RADIUS, // —Ü–µ–Ω—Ç—Ä –ø–æ –Ω–æ–≥–∞–º
        drawW,
        drawH
      );
    }

    // ==== –°—Ç–∞—Ä—Ç ====
    resizeCanvas();
    requestAnimationFrame(loop);
  </script>
</body>
</html>