<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Gypsy Bottle Game ‚Äì Animated</title>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <style>
    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      -webkit-user-select: none;
      user-select: none;
      overscroll-behavior: none;
      touch-action: none;
    }

    #gameWrapper {
      position: fixed;
      inset: 0;
      background: #000;
      overflow: hidden;
    }

    #gameCanvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
    }

    /* HUD */

    #hud {
      position: absolute;
      top: 10px;
      left: 12px;
      z-index: 10;
      display: flex;
      gap: 18px;
      align-items: center;
      color: #ffffff;
      font-size: 18px;
      font-weight: 500;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.9);
    }

    #timer,
    #score {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #scoreIcon {
      font-size: 20px;
    }

    /* Start overlay */

    #startOverlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 15;
      pointer-events: auto;
    }

    #startButton {
      padding: 18px 52px;
      border-radius: 999px;
      border: none;
      outline: none;
      font-size: 22px;
      font-weight: 600;
      color: #ffffff;
      background: linear-gradient(135deg, #ffb347, #ff8c00);
      box-shadow: 0 14px 35px rgba(0, 0, 0, 0.9);
      letter-spacing: 0.02em;
      cursor: pointer;
      transform: translateY(0);
      transition:
        transform 0.12s ease-out,
        box-shadow 0.12s ease-out,
        opacity 0.15s ease-out;
    }

    #startButton:active {
      transform: translateY(3px);
      box-shadow: 0 7px 18px rgba(0, 0, 0, 0.9);
    }

    /* Joystick */

    #joystick {
      position: absolute;
      bottom: 6%;
      left: 50%;
      transform: translateX(-50%);
      width: 46vw;
      max-width: 260px;
      aspect-ratio: 1;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #3f3f3f, #101010);
      box-shadow:
        0 0 50px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(255, 255, 255, 0.04);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 12;
      touch-action: none;
      -webkit-touch-callout: none;
    }

    #joystickInner {
      width: 46%;
      aspect-ratio: 1;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffe27a, #f6a800);
      box-shadow:
        0 0 32px rgba(0, 0, 0, 0.9),
        0 0 0 3px rgba(0, 0, 0, 0.65);
      transition: transform 0.06s linear;
      pointer-events: none;
      transform: translate3d(0, 0, 0);
    }

    /* Subtle fade when game inactive */

    .disabledOverlay #startButton {
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div id="gameWrapper">
    <canvas id="gameCanvas"></canvas>

    <div id="hud">
      <div id="timer">
        <span id="timeValue">30</span>
        <span>s</span>
      </div>
      <div id="score">
        <span id="scoreIcon">üçæ</span>
        <span id="scoreValue">0</span>
      </div>
    </div>

    <div id="startOverlay">
      <button id="startButton">–ò–≥—Ä–∞—Ç—å 30 —Å–µ–∫</button>
    </div>

    <div id="joystick">
      <div id="joystickInner"></div>
    </div>
  </div>

  <script>
    "use strict";

    // === DOM ===

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const hudTimeEl = document.getElementById("timeValue");
    const hudScoreEl = document.getElementById("scoreValue");
    const startOverlay = document.getElementById("startOverlay");
    const startButton = document.getElementById("startButton");
    const joystickEl = document.getElementById("joystick");
    const joystickInnerEl = document.getElementById("joystickInner");

    // === Layout / sizes ===

    let mapRect = { x: 0, y: 0, width: 0, height: 0 };

    function resizeCanvas() {
      const w = window.innerWidth;
      const h = window.innerHeight;

      canvas.width = w;
      canvas.height = h;

      updateMapLayout();
    }

    window.addEventListener("resize", resizeCanvas);

    // === Images / assets ===

    const images = {
      map: new Image(),
      player: new Image(),
      bottle: new Image()
    };

    let assetsLoaded = 0;
    let assetsFailed = false;
    const REQUIRED_ASSETS = 3;

    function handleAssetLoad() {
      assetsLoaded++;
      if (assetsLoaded >= REQUIRED_ASSETS && !assetsFailed) {
        // everything ready, can init game
        initGameAfterAssets();
      }
    }

    function handleAssetError(ev) {
      console.error("Asset load error:", ev?.target?.src || ev);
      assetsFailed = true;
    }

    images.map.onload = handleAssetLoad;
    images.map.onerror = handleAssetError;
    images.map.src = "assets/city-map.png";

    images.player.onload = handleAssetLoad;
    images.player.onerror = handleAssetError;
    images.player.src = "assets/gypsy.png";

    images.bottle.onload = handleAssetLoad;
    images.bottle.onerror = handleAssetError;
    images.bottle.src = "assets/bottle.png";

    // === Game constants ===

    const GAME_DURATION = 30; // seconds
    const PLAYER_BASE_SPEED = 145; // px / sec
    const PLAYER_SPRITE_COLS = 3;
    const PLAYER_SPRITE_ROWS = 3;

    // row mapping: 0 ‚Äì facing down, 1 ‚Äì facing left, 2 ‚Äì facing right
    // we –Ω–µ–º–Ω–æ–≥–æ —Å—Ö–∏—Ç—Ä–∏–º, —Ç.–∫. –≤ —Å–ø—Ä–∞–π—Ç–µ –Ω–µ –≤—Å–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–¥–µ–∞–ª—å–Ω—ã
    const DIR_DOWN = 0;
    const DIR_LEFT = 1;
    const DIR_RIGHT = 2;
    const DIR_UP = 3; // –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ "–Ω–∞–∑–∞–¥"

    const BOTTLE_COUNT = 12;
    const BOTTLE_RADIUS = 20;

    // === Game state ===

    const player = {
      x: 0,
      y: 0,
      radius: 26,
      speed: PLAYER_BASE_SPEED,
      dir: DIR_DOWN,
      moving: false,
      frameIndex: 1,
      frameTime: 0,
      frameDuration: 0.12, // seconds per frame
      spriteWidth: 0,
      spriteHeight: 0
    };

    const bottles = [];

    let gameRunning = false;
    let gameEverStarted = false;
    let gameTimeLeft = GAME_DURATION;
    let gameScore = 0;
    let timerIntervalId = null;
    let lastFrameTimestamp = 0;

    // === Joystick state ===

    const joystick = {
      active: false,
      startX: 0,
      startY: 0,
      dx: 0,
      dy: 0,
      maxRadius: 80,
      deadZone: 8
    };

    // === Helpers ===

    function clamp(value, min, max) {
      return value < min ? min : value > max ? max : value;
    }

    function length(dx, dy) {
      return Math.sqrt(dx * dx + dy * dy);
    }

    function updateHUD() {
      hudTimeEl.textContent = String(Math.max(0, Math.floor(gameTimeLeft)));
      hudScoreEl.textContent = String(gameScore);
    }

    function showStartOverlay() {
      startOverlay.style.display = "flex";
    }

    function hideStartOverlay() {
      startOverlay.style.display = "flex";
      // –ª—ë–≥–∫–∞—è —Ö–∏—Ç—Ä–æ—Å—Ç—å: –º—ã –¥–µ–ª–∞–µ–º overlay –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º,
      // –Ω–æ –Ω–µ –º–µ—à–∞—é—â–∏–º –∫–ª–∏–∫–∞–º, —á—Ç–æ–±—ã –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–µ –¥—ë—Ä–≥–∞–ª–∏—Å—å
      startOverlay.style.display = "none";
    }

    // === Map layout ===

    function updateMapLayout() {
      const w = canvas.width;
      const h = canvas.height;

      // –¥–æ–ª—è —ç–∫—Ä–∞–Ω–∞ –ø–æ–¥ –¥–∂–æ–π—Å—Ç–∏–∫
      const joystickAreaHeight = h * 0.3;

      const availableHeight = h - joystickAreaHeight;
      const mapImgAspect =
        images.map && images.map.width && images.map.height
          ? images.map.width / images.map.height
          : 0.75;

      let mapHeight = availableHeight;
      let mapWidth = mapHeight * mapImgAspect;

      if (mapWidth > w) {
        const scale = w / mapWidth;
        mapWidth *= scale;
        mapHeight *= scale;
      }

      const mapX = (w - mapWidth) / 2;
      const mapY = 0;

      mapRect.x = mapX;
      mapRect.y = mapY;
      mapRect.width = mapWidth;
      mapRect.height = mapHeight;
    }

    function initGameAfterAssets() {
      // sprite sizes
      if (images.player.width && images.player.height) {
        player.spriteWidth = images.player.width / PLAYER_SPRITE_COLS;
        player.spriteHeight = images.player.height / PLAYER_SPRITE_ROWS;
      }

      resizeCanvas(); // also updates map layout

      // center player in map
      player.radius = Math.min(canvas.width, canvas.height) * 0.045;
      if (player.radius < 18) player.radius = 18;
      if (player.radius > 40) player.radius = 40;

      player.x = mapRect.x + mapRect.width / 2;
      player.y = mapRect.y + mapRect.height / 2;

      spawnInitialBottles();

      updateHUD();

      if (!gameEverStarted) {
        drawScene(0); // –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
      }
    }

    function spawnInitialBottles() {
      bottles.length = 0;
      for (let i = 0; i < BOTTLE_COUNT; i++) {
        bottles.push(generateBottle());
      }
    }

    function generateBottle() {
      const margin = player.radius * 1.4;

      const bx =
        mapRect.x +
        margin +
        Math.random() * Math.max(10, mapRect.width - margin * 2);

      const by =
        mapRect.y +
        margin +
        Math.random() * Math.max(10, mapRect.height - margin * 2);

      return { x: bx, y: by };
    }

    // === Game control ===

    function startGame() {
      if (assetsFailed) {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã –∏–≥—Ä—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ assets.");
        return;
      }

      if (assetsLoaded < REQUIRED_ASSETS) {
        return;
      }

      gameRunning = true;
      gameEverStarted = true;
      gameTimeLeft = GAME_DURATION;
      gameScore = 0;
      updateHUD();

      // –ø–µ—Ä–µ—Å–ø–∞–≤–Ω–∏–º –±—É—Ç—ã–ª–∫–∏, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
      spawnInitialBottles();

      if (timerIntervalId !== null) {
        clearInterval(timerIntervalId);
        timerIntervalId = null;
      }

      timerIntervalId = setInterval(() => {
        gameTimeLeft -= 1;
        if (gameTimeLeft <= 0) {
          gameTimeLeft = 0;
          stopGame();
        }
        updateHUD();
      }, 1000);

      hideStartOverlay();
    }

    function stopGame() {
      gameRunning = false;
      joystick.active = false;
      joystick.dx = 0;
      joystick.dy = 0;
      joystickInnerEl.style.transform = "translate3d(0,0,0)";

      if (timerIntervalId !== null) {
        clearInterval(timerIntervalId);
        timerIntervalId = null;
      }

      // –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç, —á—Ç–æ–±—ã –Ω–µ –º–æ—Ä–≥–∞–ª–æ
      setTimeout(() => {
        startOverlay.style.display = "flex";
      }, 120);
    }

    // === Joystick handling ===

    function getJoystickCenter() {
      const rect = joystickEl.getBoundingClientRect();
      return {
        x: rect.left + rect.width / 2,
        y: rect.top + rect.height / 2
      };
    }

    function joystickStart(clientX, clientY) {
      joystick.active = true;
      const center = getJoystickCenter();
      joystick.startX = center.x;
      joystick.startY = center.y;
      joystickMove(clientX, clientY);
    }

    function joystickMove(clientX, clientY) {
      if (!joystick.active) return;

      const dx = clientX - joystick.startX;
      const dy = clientY - joystick.startY;
      let dist = length(dx, dy);

      let nx = 0;
      let ny = 0;

      if (dist > joystick.deadZone) {
        const maxRadius = joystick.maxRadius;
        const clamped = Math.min(dist, maxRadius);
        nx = dx / dist;
        ny = dy / dist;

        joystickInnerEl.style.transform =
          "translate3d(" +
          nx * clamped +
          "px," +
          ny * clamped +
          "px,0)";
      } else {
        joystickInnerEl.style.transform = "translate3d(0,0,0)";
      }

      joystick.dx = nx;
      joystick.dy = ny;
    }

    function joystickEnd() {
      joystick.active = false;
      joystick.dx = 0;
      joystick.dy = 0;
      joystickInnerEl.style.transform = "translate3d(0,0,0)";
    }

    const supportsTouch = "ontouchstart" in window || navigator.maxTouchPoints > 0;

    if (supportsTouch) {
      joystickEl.addEventListener(
        "touchstart",
        (e) => {
          if (e.touches.length > 0) {
            const t = e.touches[0];
            joystickStart(t.clientX, t.clientY);
            e.preventDefault();
          }
        },
        { passive: false }
      );

      joystickEl.addEventListener(
        "touchmove",
        (e) => {
          if (e.touches.length > 0) {
            const t = e.touches[0];
            joystickMove(t.clientX, t.clientY);
            e.preventDefault();
          }
        },
        { passive: false }
      );

      joystickEl.addEventListener(
        "touchend",
        (e) => {
          joystickEnd();
          e.preventDefault();
        },
        { passive: false }
      );

      joystickEl.addEventListener(
        "touchcancel",
        (e) => {
          joystickEnd();
          e.preventDefault();
        },
        { passive: false }
      );
    } else {
      joystickEl.addEventListener("mousedown", (e) => {
        joystickStart(e.clientX, e.clientY);
      });

      window.addEventListener("mousemove", (e) => {
        if (!joystick.active) return;
        joystickMove(e.clientX, e.clientY);
      });

      window.addEventListener("mouseup", () => {
        joystickEnd();
      });
    }

    // === Input: start button ===

    startButton.addEventListener("click", () => {
      startGame();
    });

    // === Game update & drawing ===

    function updatePlayer(dt) {
      let vx = joystick.dx;
      let vy = joystick.dy;

      const len = length(vx, vy);
      if (len < 0.01) {
        player.moving = false;
        player.frameTime = 0;
        // –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–π –∫–∞–¥—Ä
        player.frameIndex = 1;
        return;
      }

      vx /= len;
      vy /= len;

      player.moving = true;

      // –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
      if (Math.abs(vx) > Math.abs(vy)) {
        if (vx > 0) {
          player.dir = DIR_RIGHT;
        } else {
          player.dir = DIR_LEFT;
        }
      } else {
        if (vy > 0) {
          player.dir = DIR_DOWN;
        } else {
          player.dir = DIR_UP;
        }
      }

      const speed = player.speed;
      let moveX = vx * speed * dt;
      let moveY = vy * speed * dt;

      let newX = player.x + moveX;
      let newY = player.y + moveY;

      const r = player.radius * 0.9;

      const minX = mapRect.x + r;
      const maxX = mapRect.x + mapRect.width - r;
      const minY = mapRect.y + r;
      const maxY = mapRect.y + mapRect.height - r;

      newX = clamp(newX, minX, maxX);
      newY = clamp(newY, minY, maxY);

      player.x = newX;
      player.y = newY;

      // –∞–Ω–∏–º–∞—Ü–∏—è –∫–∞–¥—Ä–æ–≤
      player.frameTime += dt;
      if (player.frameTime >= player.frameDuration) {
        player.frameTime = 0;
        player.frameIndex = (player.frameIndex + 1) % PLAYER_SPRITE_COLS;
      }
    }

    function updateBottles() {
      const pr = player.radius * 0.85;
      const collectDist = pr + BOTTLE_RADIUS;

      for (let i = 0; i < bottles.length; i++) {
        const b = bottles[i];
        const dx = b.x - player.x;
        const dy = b.y - player.y;
        const dist = length(dx, dy);

        if (dist < collectDist) {
          gameScore += 1;
          updateHUD();
          bottles[i] = generateBottle();
        }
      }
    }

    function updateGame(dt) {
      if (!gameRunning) return;

      updatePlayer(dt);
      updateBottles();
    }

    function drawMap() {
      if (images.map && images.map.complete && images.map.naturalWidth > 0) {
        ctx.drawImage(
          images.map,
          0,
          0,
          images.map.width,
          images.map.height,
          mapRect.x,
          mapRect.y,
          mapRect.width,
          mapRect.height
        );
      } else {
        ctx.fillStyle = "#303030";
        ctx.fillRect(mapRect.x, mapRect.y, mapRect.width, mapRect.height);
      }
    }

    function drawBottles() {
      for (let i = 0; i < bottles.length; i++) {
        const b = bottles[i];
        const size = BOTTLE_RADIUS * 2;

        if (
          images.bottle &&
          images.bottle.complete &&
          images.bottle.naturalWidth > 0
        ) {
          ctx.drawImage(
            images.bottle,
            b.x - BOTTLE_RADIUS,
            b.y - BOTTLE_RADIUS,
            size,
            size
          );
        } else {
          ctx.fillStyle = "#8ccfff";
          ctx.beginPath();
          ctx.arc(b.x, b.y, BOTTLE_RADIUS, 0, Math.PI * 2);
          ctx.fill();
        }
      }
    }

    function drawPlayer() {
      const px = player.x;
      const py = player.y;
      const r = player.radius;

      const img = images.player;

      if (
        img &&
        img.complete &&
        img.naturalWidth > 0 &&
        player.spriteWidth > 0 &&
        player.spriteHeight > 0
      ) {
        let rowIndex = 0;
        switch (player.dir) {
          case DIR_DOWN:
            rowIndex = 0;
            break;
          case DIR_LEFT:
            rowIndex = 2; // —á—É—Ç—å –Ω–∞–∏—Å–∫–æ—Å—å
            break;
          case DIR_RIGHT:
            rowIndex = 2;
            break;
          case DIR_UP:
            rowIndex = 1; // –≤–∏–¥ —Å–æ —Å–ø–∏–Ω—ã
            break;
          default:
            rowIndex = 0;
        }

        const frame = clamp(
          player.frameIndex,
          0,
          PLAYER_SPRITE_COLS - 1
        );

        const sx = frame * player.spriteWidth;
        const sy = rowIndex * player.spriteHeight;
        const sw = player.spriteWidth;
        const sh = player.spriteHeight;

        const dw = r * 2;
        const dh = r * 2.2; // —á—É—Ç—å –≤—ã—Ç—è–Ω—É—Ç –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏

        ctx.save();
        ctx.translate(px, py);
        ctx.drawImage(img, sx, sy, sw, sh, -dw / 2, -dh / 2, dw, dh);
        ctx.restore();
      } else {
        // fallback ‚Äì –∫—Ä—É–≥, –µ—Å–ª–∏ —Å–ø—Ä–∞–π—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
        ctx.fillStyle = "#ffd54f";
        ctx.beginPath();
        ctx.arc(px, py, r, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function drawScene(dt) {
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (assetsFailed) {
        ctx.fillStyle = "#111";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#ff6666";
        ctx.font = "18px system-ui";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(
          "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏–≥—Ä—ã",
          canvas.width / 2,
          canvas.height / 2
        );
        return;
      }

      if (assetsLoaded < REQUIRED_ASSETS) {
        ctx.fillStyle = "#111";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#ffffff";
        ctx.font = "18px system-ui";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(
          "–ó–∞–≥—Ä—É–∑–∫–∞...",
          canvas.width / 2,
          canvas.height / 2
        );
        return;
      }

      drawMap();
      drawBottles();
      drawPlayer();
    }

    function gameLoop(timestamp) {
      if (!lastFrameTimestamp) lastFrameTimestamp = timestamp;
      const dt = (timestamp - lastFrameTimestamp) / 1000;
      lastFrameTimestamp = timestamp;

      updateGame(dt);
      drawScene(dt);

      requestAnimationFrame(gameLoop);
    }

    // === Init ===

    resizeCanvas();
    updateHUD();
    requestAnimationFrame(gameLoop);
  </script>
</body>
</html>