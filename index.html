<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Gypsy Bottle Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      touch-action: none;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #gameCanvas {
      display: block;
      width: 100vw;
      height: 100vh;
    }

    #hud {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 10;
      color: #fff;
      font-size: 20px;
      font-weight: 600;
      text-shadow: 0 0 6px rgba(0,0,0,0.9);
      pointer-events: none;
    }

    #startButton {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      padding: 16px 32px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ffcc4d, #ff8c1a);
      color: #fff;
      font-size: 22px;
      font-weight: 700;
      border: none;
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
      outline: none;
      cursor: pointer;
      z-index: 20;
    }

    #startButton:active {
      transform: translate(-50%, -50%) translateY(2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.7);
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="hud">30 s ü•Ç 0</div>
  <button id="startButton">–ò–≥—Ä–∞—Ç—å 30 —Å–µ–∫</button>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const hud = document.getElementById('hud');
    const startButton = document.getElementById('startButton');

    const DPR = window.devicePixelRatio || 1;

    function resize() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      canvas.width = w * DPR;
      canvas.height = h * DPR;
      ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    }
    window.addEventListener('resize', resize);
    resize();

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ ---
    const mapImg = new Image();
    mapImg.src = 'assets/city-map.png';

    const playerImg = new Image();
    playerImg.src = 'assets/gypsy.png';

    const bottleImg = new Image();
    bottleImg.src = 'assets/bottle.png';

    let mapReady = false;
    let playerReady = false;
    let bottleReady = false;

    mapImg.onload = () => {
      mapReady = true;
      initCollisionMap();
      placePlayerOnRoad();
    };
    playerImg.onload = () => { playerReady = true; };
    bottleImg.onload = () => { bottleReady = true; };

    // --- –ö–∞–Ω–≤–∞—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ---
    const collisionCanvas = document.createElement('canvas');
    const collisionCtx = collisionCanvas.getContext('2d');

    function initCollisionMap() {
      collisionCanvas.width = mapImg.width;
      collisionCanvas.height = mapImg.height;
      collisionCtx.drawImage(mapImg, 0, 0);
    }

    // --- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä–æ–∫–∞ ---
    const player = {
      x: 768,       // –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —Ü–µ–Ω—Ç—Ä, –ø–æ—Ç–æ–º –ø–æ—Å—Ç–∞–≤–∏–º –Ω–∞ –¥–æ—Ä–æ–≥—É
      y: 512,
      size: 60,
      speed: 140,   // –ø–∏–∫—Å–µ–ª–µ–π –≤ —Å–µ–∫—É–Ω–¥—É
      vx: 0,
      vy: 0,
      dir: 'down',
      frame: 0,
      frameTimer: 0,
      frameInterval: 0.12
    };

    // –†–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞ —Å–ø—Ä–∞–π—Ç–∞ (gypsy.png 3x3)
    let frameW = 0;
    let frameH = 0;
    playerImg.onload = () => {
      playerReady = true;
      frameW = playerImg.width / 3;
      frameH = playerImg.height / 3;
    };

    // --- –ö–∞–º–µ—Ä–∞ ---
    const camera = { x: player.x, y: player.y };

    // --- –î–∂–æ–π—Å—Ç–∏–∫ ---
    const joystick = {
      active: false,
      id: null,
      baseX: 0,
      baseY: 0,
      curX: 0,
      curY: 0,
      radius: 70,
      innerRadius: 30,
      vectorX: 0,
      vectorY: 0
    };

    function pointerDown(e) {
      const touch = e.touches ? e.touches[0] : e;
      joystick.active = true;
      joystick.id = touch.identifier !== undefined ? touch.identifier : 'mouse';
      joystick.baseX = touch.clientX;
      joystick.baseY = touch.clientY;
      joystick.curX = touch.clientX;
      joystick.curY = touch.clientY;
      joystick.vectorX = 0;
      joystick.vectorY = 0;
    }

    function pointerMove(e) {
      if (!joystick.active) return;
      let touch;
      if (e.touches) {
        touch = Array.from(e.touches).find(t => t.identifier === joystick.id);
        if (!touch) return;
      } else {
        touch = e;
      }

      const dx = touch.clientX - joystick.baseX;
      const dy = touch.clientY - joystick.baseY;
      const dist = Math.hypot(dx, dy);
      const maxR = joystick.radius;

      let nx = dx;
      let ny = dy;
      if (dist > maxR) {
        nx = dx * maxR / dist;
        ny = dy * maxR / dist;
      }

      joystick.curX = joystick.baseX + nx;
      joystick.curY = joystick.baseY + ny;

      if (dist > 10) {
        joystick.vectorX = dx / dist;
        joystick.vectorY = dy / dist;
      } else {
        joystick.vectorX = 0;
        joystick.vectorY = 0;
      }
    }

    function pointerUp(e) {
      joystick.active = false;
      joystick.id = null;
      joystick.vectorX = 0;
      joystick.vectorY = 0;
    }

    canvas.addEventListener('touchstart', pointerDown);
    canvas.addEventListener('touchmove', pointerMove);
    canvas.addEventListener('touchend', pointerUp);
    canvas.addEventListener('mousedown', pointerDown);
    window.addEventListener('mousemove', pointerMove);
    window.addEventListener('mouseup', pointerUp);

    // --- –õ–æ–≥–∏–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ —Ü–≤–µ—Ç—É –∫–∞—Ä—Ç—ã ---
    function isWalkablePixel(mapX, mapY) {
      if (!mapReady) return false;
      if (mapX < 0 || mapY < 0 || mapX >= mapImg.width || mapY >= mapImg.height) return false;

      const data = collisionCtx.getImageData(Math.floor(mapX), Math.floor(mapY), 1, 1).data;
      const r = data[0], g = data[1], b = data[2];

      const brightness = (r + g + b) / 3;
      const maxDiff = Math.max(
        Math.abs(r - g),
        Math.abs(g - b),
        Math.abs(r - b)
      );

      // –°–≤–µ—Ç–ª—ã–µ –¥–æ—Ä–æ–≥–∏ (–ø–æ—á—Ç–∏ –±–µ–ª—ã–µ)
      const isRoad =
        brightness > 220 &&
        maxDiff < 25;

      // –ó–µ–ª—ë–Ω–∞—è —Ç—Ä–∞–≤–∞ / –ø–∞—Ä–∫–∏: —á—É—Ç—å —Ç–µ–º–Ω–µ–µ –∏ –±–æ–ª–µ–µ –∑–µ–ª—ë–Ω—ã–µ
      const isGrass =
        brightness > 150 && brightness < 230 &&
        g >= r - 10 && g >= b &&
        b >= g - 60;

      // –ú–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–¥–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–∏ —á–∏—Å–ª–∞, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç.
      return isRoad || isGrass;
    }

    function canMoveTo(nx, ny) {
      const r = player.size * 0.35;

      const points = [
        { x: nx,     y: ny - r }, // –≤–≤–µ—Ä—Ö
        { x: nx,     y: ny + r }, // –≤–Ω–∏–∑
        { x: nx - r, y: ny },     // –≤–ª–µ–≤–æ
        { x: nx + r, y: ny }      // –≤–ø—Ä–∞–≤–æ
      ];

      return points.every(p => isWalkablePixel(p.x, p.y));
    }

    function placePlayerOnRoad() {
      if (!mapReady) return;
      // –∏—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –¥–æ—Ä–æ–≥—É –æ–∫–æ–ª–æ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã
      let startX = mapImg.width * 0.5;
      let startY = mapImg.height * 0.5;

      let found = false;
      const maxRadius = Math.max(mapImg.width, mapImg.height) / 2;

      for (let r = 0; r < maxRadius && !found; r += 5) {
        for (let angle = 0; angle < Math.PI * 2; angle += Math.PI / 18) {
          const x = startX + Math.cos(angle) * r;
          const y = startY + Math.sin(angle) * r;
          if (isWalkablePixel(x, y)) {
            player.x = x;
            player.y = y;
            camera.x = x;
            camera.y = y;
            found = true;
            break;
          }
        }
      }
    }

    // --- –ë—É—Ç—ã–ª–∫–∏ ---
    const bottles = [];
    const maxBottles = 10;
    let score = 0;

    function spawnBottle() {
      if (!mapReady) return;
      for (let attempts = 0; attempts < 200; attempts++) {
        const x = Math.random() * mapImg.width;
        const y = Math.random() * mapImg.height;

        if (!isWalkablePixel(x, y)) continue;

        let tooClose = false;
        if (Math.hypot(x - player.x, y - player.y) < 120) tooClose = true;

        for (const b of bottles) {
          if (Math.hypot(x - b.x, y - b.y) < 80) {
            tooClose = true;
            break;
          }
        }
        if (tooClose) continue;

        bottles.push({ x, y });
        break;
      }
    }

    function ensureBottles() {
      while (bottles.length < maxBottles) {
        spawnBottle();
      }
    }

    // --- –¢–∞–π–º–µ—Ä ---
    let timeLeft = 30;
    let gameRunning = false;

    function resetGame() {
      score = 0;
      timeLeft = 30;
      player.x = mapImg.width * 0.5;
      player.y = mapImg.height * 0.5;
      placePlayerOnRoad();
      bottles.length = 0;
      ensureBottles();
      gameRunning = true;
    }

    startButton.addEventListener('click', () => {
      if (!mapReady || !playerReady) return;
      resetGame();
      startButton.style.display = 'none';
    });

    // --- –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª ---
    let lastTime = performance.now();

    function update(dt) {
      if (!gameRunning) return;

      // —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç –¥–∂–æ–π—Å—Ç–∏–∫–∞
      const vx = joystick.vectorX;
      const vy = joystick.vectorY;

      if (Math.abs(vx) > 0.01 || Math.abs(vy) > 0.01) {
        const moveSpeed = player.speed * dt;
        const nx = player.x + vx * moveSpeed;
        const ny = player.y + vy * moveSpeed;

        // –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏)
        if (Math.abs(vx) > Math.abs(vy)) {
          player.dir = vx > 0 ? 'right' : 'left';
        } else {
          player.dir = vy > 0 ? 'down' : 'up';
        }

        // —Å–Ω–∞—á–∞–ª–∞ –ø–æ X, –ø–æ—Ç–æ–º –ø–æ Y, —á—Ç–æ–±—ã –º—è–≥–∫–æ —Å–∫–æ–ª—å–∑–∏—Ç—å –≤–¥–æ–ª—å —Å—Ç–µ–Ω
        if (canMoveTo(nx, player.y)) {
          player.x = nx;
        }
        if (canMoveTo(player.x, ny)) {
          player.y = ny;
        }

        // –∞–Ω–∏–º–∞—Ü–∏—è —Ö–æ–¥—å–±—ã
        player.frameTimer += dt;
        if (player.frameTimer >= player.frameInterval) {
          player.frameTimer = 0;
          player.frame = (player.frame + 1) % 3;
        }
      } else {
        // —Å—Ç–æ–∏–º ‚Äî –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä
        player.frame = 1;
      }

      // –∫–∞–º–µ—Ä–∞ —Å–ª–µ–¥—É–µ—Ç
      camera.x = player.x;
      camera.y = player.y;

      // —Å–±–æ—Ä –±—É—Ç—ã–ª–æ–∫
      for (let i = bottles.length - 1; i >= 0; i--) {
        const b = bottles[i];
        const dist = Math.hypot(b.x - player.x, b.y - player.y);
        if (dist < 40) {
          bottles.splice(i, 1);
          score++;
        }
      }
      ensureBottles();

      // —Ç–∞–π–º–µ—Ä
      timeLeft -= dt;
      if (timeLeft <= 0) {
        timeLeft = 0;
        gameRunning = false;
        startButton.textContent = `–°—ã–≥—Ä–∞—Ç—å –µ—â—ë (ü•Ç ${score})`;
        startButton.style.display = 'block';
      }
    }

    function drawJoystick() {
      if (!joystick.baseX) {
        // —Å—Ç–∞–≤–∏–º –¥–∂–æ–π—Å—Ç–∏–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–Ω–∏–∑—É, –µ—Å–ª–∏ –µ—â—ë –Ω–µ —Ç—Ä–æ–≥–∞–ª–∏
        joystick.baseX = canvas.width / DPR / 2;
        joystick.baseY = canvas.height / DPR * 0.8;
        joystick.curX = joystick.baseX;
        joystick.curY = joystick.baseY;
      }

      const baseX = joystick.baseX;
      const baseY = joystick.baseY;

      // –≤–Ω–µ—à–Ω–µ–µ –∫–æ–ª—å—Ü–æ
      ctx.beginPath();
      ctx.arc(baseX, baseY, joystick.radius, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(0,0,0,0.55)';
      ctx.fill();

      // –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä—É–≥
      const cx = joystick.active ? joystick.curX : baseX;
      const cy = joystick.active ? joystick.curY : baseY;
      ctx.beginPath();
      ctx.arc(cx, cy, joystick.innerRadius, 0, Math.PI * 2);
      const grd = ctx.createRadialGradient(cx, cy, 5, cx, cy, joystick.innerRadius);
      grd.addColorStop(0, '#ffd34d');
      grd.addColorStop(1, '#ff9f1c');
      ctx.fillStyle = grd;
      ctx.fill();
      ctx.shadowColor = 'rgba(0,0,0,0.8)';
      ctx.shadowBlur = 18;
      ctx.shadowOffsetY = 4;
      ctx.shadowColor = 'transparent';
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width / DPR, canvas.height / DPR);

      const screenW = canvas.width / DPR;
      const screenH = canvas.height / DPR;

      if (mapReady) {
        const mapX = Math.floor(screenW / 2 - camera.x);
        const mapY = Math.floor(screenH / 2 - camera.y);
        ctx.drawImage(mapImg, mapX, mapY);
      }

      // –±—É—Ç—ã–ª–∫–∏
      if (bottleReady) {
        for (const b of bottles) {
          const screenX = b.x - camera.x + screenW / 2;
          const screenY = b.y - camera.y + screenH / 2;
          const size = 32;
          ctx.drawImage(bottleImg, screenX - size / 2, screenY - size, size, size);
        }
      }

      // –∏–≥—Ä–æ–∫
      if (playerReady) {
        const screenX = player.x - camera.x + screenW / 2;
        const screenY = player.y - camera.y + screenH / 2;

        let row = 0;
        if (player.dir === 'down') row = 0;
        else if (player.dir === 'up') row = 1;
        else if (player.dir === 'left' || player.dir === 'right') row = 2;

        let col = player.frame;

        let flip = false;
        if (player.dir === 'right') flip = true;

        const sx = col * frameW;
        const sy = row * frameH;
        const dstW = player.size;
        const dstH = player.size;

        ctx.save();
        ctx.translate(screenX, screenY);
        if (flip) ctx.scale(-1, 1);
        ctx.drawImage(
          playerImg,
          sx, sy, frameW, frameH,
          -dstW / 2, -dstH, dstW, dstH
        );
        ctx.restore();
      }

      // –¥–∂–æ–π—Å—Ç–∏–∫
      drawJoystick();

      // HUD
      hud.textContent = `${Math.ceil(timeLeft)} s ü•Ç ${score}`;
    }

    function loop(now) {
      const dt = (now - lastTime) / 1000;
      lastTime = now;
      update(dt);
      draw();
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  </script>
</body>
</html>