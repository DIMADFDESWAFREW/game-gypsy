
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Gypsy Bottle Game - Animated</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }

    #gameWrapper {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
    }

    #gameCanvas {
      width: 100%;
      height: 100%;
      display: block;
      background: #222;
      touch-action: none;
    }

    #hud {
      position: absolute;
      top: 8px;
      left: 10px;
      z-index: 3;
      padding: 4px 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      color: #f8f8f8;
      text-shadow: 0 0 4px #000;
    }
    #hud span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #startBtn {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      padding: 10px 22px;
      border-radius: 999px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #ffd54f, #ff9100);
      color: #222;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
      z-index: 4;
    }
    #startBtn:active {
      transform: translate(-50%, -50%) scale(0.97);
    }

    #centerMessage {
      position: absolute;
      left: 50%;
      top: 40%;
      transform: translateX(-50%);
      color: #fff;
      font-size: 20px;
      text-align: center;
      text-shadow: 0 0 6px #000;
      z-index: 3;
      padding: 0 12px;
      pointer-events: none;
    }

    #controls {
      position: absolute;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      width: min(340px, 80vw);
      display: flex;
      justify-content: center;
      z-index: 3;
      pointer-events: none;
    }

    .stick-wrapper {
      position: relative;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: radial-gradient(circle, #222 0, #000 70%);
      box-shadow: 0 0 12px rgba(0,0,0,0.7);
      border: 2px solid rgba(255,255,255,0.1);
      touch-action: none;
      pointer-events: auto;
    }

    .stick-inner {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 72px;
      height: 72px;
      margin-left: -36px;
      margin-top: -36px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffeb3b, #ff9100);
      box-shadow: 0 0 18px rgba(0,0,0,0.8);
      touch-action: none;
    }

    #infoBanner {
      position: absolute;
      bottom: 210px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.65);
      color: #fff;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      z-index: 3;
      display: none;
      backdrop-filter: blur(6px);
    }

    @media (min-width: 768px) {
      #hud { font-size: 20px; }
      .stick-wrapper { width: 200px; height: 200px; }
      .stick-inner { width: 80px; height: 80px; margin-left: -40px; margin-top: -40px; }
    }
  </style>
</head>
<body>
<div id="gameWrapper">
  <canvas id="gameCanvas"></canvas>

  <div id="hud">
    <span><span id="time">30</span>s</span>
    <span>üçæ <span id="score">0</span></span>
  </div>

  <button id="startBtn">–ò–≥—Ä–∞—Ç—å 30 —Å–µ–∫</button>
  <div id="centerMessage"></div>
  <div id="infoBanner">–î–≤–∏–≥–∞–π –¥–∂–æ–π—Å—Ç–∏–∫, —á—Ç–æ–±—ã –∏–¥—Ç–∏ –∏ —Å–æ–±–∏—Ä–∞—Ç—å –±—É—Ç—ã–ª–∫–∏</div>

  <div id="controls">
    <div class="stick-wrapper" id="stickWrapper">
      <div class="stick-inner" id="stickInner"></div>
    </div>
  </div>
</div>

<script>
const GAME_TIME = 30;
const PLAYER_SPEED = 200;
const BOTTLE_SIZE = 40;
const MAX_BOTTLES = 10;
const BOTTLE_SPAWN_INTERVAL = 700; // –º—Å
const FRAME_TIME = 120; // –º—Å –º–µ–∂–¥—É –∫–∞–¥—Ä–∞–º–∏ —à–∞–≥–∞

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

function resize() {
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
}
window.addEventListener('resize', resize);
resize();

const timeEl = document.getElementById('time');
const scoreEl = document.getElementById('score');
const startBtn = document.getElementById('startBtn');
const centerMessage = document.getElementById('centerMessage');
const infoBanner = document.getElementById('infoBanner');

const stickWrapper = document.getElementById('stickWrapper');
const stickInner = document.getElementById('stickInner');

// –°–ø—Ä–∞–π—Ç—ã
const mapImg = new Image();
mapImg.src = 'assets/city-map.png';

const playerImg = new Image();
playerImg.src = 'assets/gypsy.png';

const bottleImg = new Image();
bottleImg.src = 'assets/bottle.png';

// –ò–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
let cw = canvas.width;
let ch = canvas.height;

let player = {
  x: cw / 2,
  y: ch / 2,
  size: 60,
  dir: 0,          // 0-–≤–Ω–∏–∑,1-–≤–ø—Ä–∞–≤–æ,2-–≤–≤–µ—Ä—Ö,3-–≤–ª–µ–≤–æ
  frameIndex: 0,   // 0..2
  frameTimer: 0,
  moving: false
};

let sprite = {
  ready: false,
  frameW: 0,
  frameH: 0
};

playerImg.onload = () => {
  sprite.frameW = playerImg.width / 3;
  sprite.frameH = playerImg.height / 4;
  sprite.ready = true;
};

let bottles = [];
let score = 0;
let gameTimeLeft = GAME_TIME;
let isRunning = false;
let lastTs = 0;
let spawnTimer = 0;

// –í–µ–∫—Ç–æ—Ä –¥–≤–∏–∂–µ–Ω–∏—è –æ—Ç –¥–∂–æ–π—Å—Ç–∏–∫–∞
let moveVector = { x: 0, y: 0 };

// ==== –î–∂–æ–π—Å—Ç–∏–∫ ====
let stickActive = false;

function getStickRelative(clientX, clientY) {
  const rect = stickWrapper.getBoundingClientRect();
  return {
    x: clientX - rect.left - rect.width / 2,
    y: clientY - rect.top - rect.height / 2,
    maxRadius: rect.width / 2 - stickInner.offsetWidth / 2
  };
}

function setStick(dx, dy, maxRadius) {
  const dist = Math.hypot(dx, dy);
  if (dist > maxRadius && dist > 0) {
    const k = maxRadius / dist;
    dx *= k; dy *= k;
  }
  stickInner.style.transform = 'translate(' + dx + 'px,' + dy + 'px)';

  moveVector.x = dx / maxRadius;
  moveVector.y = dy / maxRadius;
}

function resetStick() {
  stickInner.style.transform = 'translate(0,0)';
  moveVector.x = 0;
  moveVector.y = 0;
}

// touch
stickWrapper.addEventListener('touchstart', (e) => {
  e.preventDefault();
  infoBanner.style.display = 'none';
  stickActive = true;
  const t = e.changedTouches[0];
  const p = getStickRelative(t.clientX, t.clientY);
  setStick(p.x, p.y, p.maxRadius);
}, { passive: false });

stickWrapper.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if (!stickActive) return;
  const t = e.changedTouches[0];
  const p = getStickRelative(t.clientX, t.clientY);
  setStick(p.x, p.y, p.maxRadius);
}, { passive: false });

stickWrapper.addEventListener('touchend', (e) => {
  e.preventDefault();
  stickActive = false;
  resetStick();
}, { passive: false });

// mouse (–¥–ª—è —Ç–µ—Å—Ç–∞ –Ω–∞ –ü–ö)
stickWrapper.addEventListener('mousedown', (e) => {
  e.preventDefault();
  infoBanner.style.display = 'none';
  stickActive = true;
  const p = getStickRelative(e.clientX, e.clientY);
  setStick(p.x, p.y, p.maxRadius);
});
window.addEventListener('mousemove', (e) => {
  if (!stickActive) return;
  const p = getStickRelative(e.clientX, e.clientY);
  setStick(p.x, p.y, p.maxRadius);
});
window.addEventListener('mouseup', () => {
  if (!stickActive) return;
  stickActive = false;
  resetStick();
});

// ==== –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã ====
function spawnBottle() {
  if (bottles.length >= MAX_BOTTLES) return;
  const margin = 30;
  const x = margin + Math.random() * (canvas.width - margin * 2);
  const y = margin + Math.random() * (canvas.height - margin * 2);
  bottles.push({ x, y, size: BOTTLE_SIZE });
}

function resetGame() {
  cw = canvas.width;
  ch = canvas.height;
  player.x = cw / 2;
  player.y = ch / 2;
  player.frameIndex = 0;
  player.frameTimer = 0;
  player.moving = false;
  bottles = [];
  score = 0;
  gameTimeLeft = GAME_TIME;
  spawnTimer = 0;
  timeEl.textContent = GAME_TIME.toString();
  scoreEl.textContent = '0';
  centerMessage.textContent = '';
}

startBtn.addEventListener('click', () => {
  resetGame();
  isRunning = true;
  startBtn.style.display = 'none';
  infoBanner.style.display = 'block';
});

// === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ: –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ –≤–µ–∫—Ç–æ—Ä—É ===
function updateDirectionFromVector(vx, vy) {
  if (Math.abs(vx) < 0.1 && Math.abs(vy) < 0.1) {
    player.moving = false;
    return;
  }
  player.moving = true;
  if (Math.abs(vx) > Math.abs(vy)) {
    // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å
    player.dir = vx > 0 ? 1 : 3; // –≤–ø—Ä–∞–≤–æ / –≤–ª–µ–≤–æ
  } else {
    // –≤–µ—Ä—Ç–∏–∫–∞–ª—å
    player.dir = vy > 0 ? 0 : 2; // –≤–Ω–∏–∑ / –≤–≤–µ—Ä—Ö
  }
}

// === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ===
function update(dt) {
  if (!isRunning) return;

  gameTimeLeft -= dt;
  if (gameTimeLeft <= 0) {
    gameTimeLeft = 0;
    isRunning = false;
    centerMessage.innerHTML = '‚è≥ –í—Ä–µ–º—è –≤—ã—à–ª–æ!<br>–¢—ã —Å–æ–±—Ä–∞–ª: <b>' + score + '</b> –±—É—Ç—ã–ª–æ–∫';
    startBtn.textContent = '–ò–≥—Ä–∞—Ç—å –µ—â—ë 30 —Å–µ–∫';
    startBtn.style.display = 'block';
  }
  timeEl.textContent = Math.ceil(gameTimeLeft).toString();

  // –¥–≤–∏–∂–µ–Ω–∏–µ –æ—Ç –¥–∂–æ–π—Å—Ç–∏–∫–∞
  const len = Math.hypot(moveVector.x, moveVector.y);
  let vx = 0, vy = 0;
  if (len > 0.1) {
    vx = (moveVector.x / len) * PLAYER_SPEED;
    vy = (moveVector.y / len) * PLAYER_SPEED;
  }
  updateDirectionFromVector(vx, vy);

  player.x += vx * dt;
  player.y += vy * dt;

  const half = player.size / 2;
  if (player.x < half) player.x = half;
  if (player.x > canvas.width - half) player.x = canvas.width - half;
  if (player.y < half) player.y = half;
  if (player.y > canvas.height - half) player.y = canvas.height - half;

  // –∞–Ω–∏–º–∞—Ü–∏—è —à–∞–≥–∞
  if (player.moving) {
    player.frameTimer += dt * 1000;
    if (player.frameTimer >= FRAME_TIME) {
      player.frameTimer -= FRAME_TIME;
      player.frameIndex = (player.frameIndex + 1) % 3; // 3 –∫–∞–¥—Ä–∞
    }
  } else {
    player.frameIndex = 0;
    player.frameTimer = 0;
  }

  // —Å–ø–∞–≤–Ω –±—É—Ç—ã–ª–æ–∫
  spawnTimer += dt * 1000;
  if (spawnTimer >= BOTTLE_SPAWN_INTERVAL) {
    spawnTimer = 0;
    spawnBottle();
  }

  // —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
  for (let i = bottles.length - 1; i >= 0; i--) {
    const b = bottles[i];
    const dx = player.x - b.x;
    const dy = player.y - b.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist < (player.size / 2 + b.size / 2) * 0.8) {
      bottles.splice(i, 1);
      score++;
      scoreEl.textContent = score.toString();
    }
  }
}

// === –†–∏—Å–æ–≤–∞–Ω–∏–µ ===
function draw() {
  // —Ñ–æ–Ω-–∫–∞—Ä—Ç–∞
  if (mapImg.complete && mapImg.naturalWidth > 0) {
    ctx.drawImage(mapImg, 0, 0, canvas.width, canvas.height);
  } else {
    ctx.fillStyle = '#444';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  // –±—É—Ç—ã–ª–∫–∏
  bottles.forEach(b => {
    if (bottleImg.complete && bottleImg.naturalWidth > 0) {
      ctx.drawImage(bottleImg, b.x - b.size/2, b.y - b.size/2, b.size, b.size);
    } else {
      ctx.fillStyle = '#aee';
      ctx.beginPath();
      ctx.arc(b.x, b.y, b.size/2, 0, Math.PI*2);
      ctx.fill();
    }
  });

  // –ø–µ—Ä—Å–æ–Ω–∞–∂
  if (sprite.ready) {
    const fw = sprite.frameW;
    const fh = sprite.frameH;
    const sx = player.frameIndex * fw;
    const sy = player.dir * fh;
    const px = player.x - player.size / 2;
    const py = player.y - player.size / 2;
    ctx.drawImage(playerImg, sx, sy, fw, fh, px, py, player.size, player.size);
  } else if (playerImg.complete && playerImg.naturalWidth > 0) {
    ctx.drawImage(playerImg, player.x - player.size/2, player.y - player.size/2, player.size, player.size);
  } else {
    ctx.fillStyle = '#ffd54f';
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.size/2, 0, Math.PI*2);
    ctx.fill();
  }
}

// === –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª ===
let lastTs = 0;
function loop(ts) {
  if (!lastTs) lastTs = ts;
  const dt = (ts - lastTs) / 1000;
  lastTs = ts;

  update(dt);
  draw();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
