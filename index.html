<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Gypsy Bottle Game ‚Äì Animated</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }

    #gameWrapper {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
    }

    #gameCanvas {
      width: 100%;
      height: 100%;
      display: block;
      background: #222;
      touch-action: none;
    }

    #hud {
      position: absolute;
      top: 8px;
      left: 10px;
      z-index: 5;
      color: #fff;
      font-size: 20px;
      text-shadow: 0 0 5px #000;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #time {
      font-weight: 600;
    }

    #score {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #scoreIcon {
      font-size: 20px;
    }

    #centerMessage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 6;
      text-align: center;
      color: #fff;
      pointer-events: none;
      font-size: 18px;
      text-shadow: 0 0 6px rgba(0,0,0,0.8);
    }

    #startBtn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 7;
      padding: 18px 48px;
      border-radius: 999px;
      border: none;
      font-size: 20px;
      font-weight: 600;
      background: linear-gradient(135deg, #ffb347, #ff8c00);
      color: #fff;
      box-shadow: 0 12px 28px rgba(0,0,0,0.55);
      cursor: pointer;
      letter-spacing: 0.03em;
      touch-action: manipulation;
    }

    #startBtn:active {
      transform: translate(-50%, -50%) scale(0.97);
      box-shadow: 0 8px 18px rgba(0,0,0,0.7);
    }

    #joystickBase {
      position: absolute;
      bottom: 8vh;
      left: 50%;
      transform: translateX(-50%);
      width: min(42vw, 260px);
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #555, #000);
      box-shadow:
        0 0 0 10px rgba(0,0,0,0.45),
        0 18px 36px rgba(0,0,0,0.85),
        inset 0 4px 12px rgba(255,255,255,0.06);
      z-index: 10;
      touch-action: none;
    }

    #joystickKnob {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 52%;
      height: 52%;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 25%, #ffd95e, #ff9f1a);
      box-shadow:
        0 8px 16px rgba(0,0,0,0.6),
        inset 0 -4px 10px rgba(0,0,0,0.55),
        inset 0 6px 12px rgba(255,255,255,0.18);
      touch-action: none;
    }

    @media (min-aspect-ratio: 3/4) {
      #joystickBase {
        bottom: 5vh;
      }
    }
  </style>
</head>
<body>
  <div id="gameWrapper">
    <canvas id="gameCanvas"></canvas>

    <div id="hud">
      <span id="time">30 s</span>
      <div id="score">
        <span id="scoreIcon">üçæ</span>
        <span id="scoreValue">0</span>
      </div>
    </div>

    <div id="centerMessage"></div>

    <button id="startBtn">–ò–≥—Ä–∞—Ç—å 30 —Å–µ–∫</button>

    <div id="joystickBase">
      <div id="joystickKnob"></div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx     = canvas.getContext('2d');

    function resize() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width  = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener('resize', resize);
    resize();

    const timeEl   = document.getElementById('time');
    const scoreEl  = document.getElementById('scoreValue');
    const startBtn = document.getElementById('startBtn');
    const centerMessage = document.getElementById('centerMessage');
    const joyBase  = document.getElementById('joystickBase');
    const joyKnob  = document.getElementById('joystickKnob');

    // üî• –ê–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏ –∫ –∞—Å—Å–µ—Ç–∞–º GitHub Pages
    const baseUrl = 'https://dimadfdeswafrew.github.io/game-gypsy';

    const mapImg = new Image();
    mapImg.src = baseUrl + '/assets/city-map.png';

    const playerImg = new Image();
    playerImg.src = baseUrl + '/assets/gypsy.png';

    const bottleImg = new Image();
    bottleImg.src = baseUrl + '/assets/bottle.png';

    const obstacleTopImg = new Image();
    obstacleTopImg.src = baseUrl + '/assets/obstacle_top.png';

    const obstacleBottomImg = new Image();
    obstacleBottomImg.src = baseUrl + '/assets/obstacle_bottom.png';

    const GAME_TIME = 30;

    const player = {
      x: 0,
      y: 0,
      size: 64,
      speed: 260,
      dir: 0,
      vx: 0,
      vy: 0,
      isMoving: false,
      frame: 0,
      frameTime: 0,
      frameDuration: 0.12
    };

    const sprite = {
      cols: 3,
      rows: 4,
      frameW: 0,
      frameH: 0
    };

    let bottles = [];
    let obstacles = [];
    let timeLeft = GAME_TIME;
    let score    = 0;
    let running  = false;
    let lastTs   = 0;

    function createObstacles() {
      obstacles = [];

      const w = 2700;
      const h = 2700;
      const roadW = 260;
      const mapCenterX = w / 2;
      const mapCenterY = h / 2;

      obstacles.push({
        type: 'top',
        x: 0,
        y: 0,
        width: w,
        height: (h - roadW) / 2,
      });

      obstacles.push({
        type: 'bottom',
        x: 0,
        y: (h + roadW) / 2,
        width: w,
        height: (h - roadW) / 2,
      });

      const houseW = 260;
      const houseH = 260;

      obstacles.push({
        type: 'middle',
        x: mapCenterX - houseW / 2,
        y: 0,
        width: houseW,
        height: (h - roadW) / 2,
      });

      obstacles.push({
        type: 'middle',
        x: mapCenterX - houseW / 2,
        y: (h + roadW) / 2,
        width: houseW,
        height: (h - roadW) / 2,
      });

      obstacles.push({
        type: 'middle',
        x: mapCenterX - roadW / 2 - houseW,
        y: mapCenterY - houseH / 2,
        width: houseW,
        height: houseH,
      });

      obstacles.push({
        type: 'middle',
        x: mapCenterX + roadW / 2,
        y: mapCenterY - houseH / 2,
        width: houseW,
        height: houseH,
      });
    }

    function rectsOverlap(a, b) {
      return (
        a.x < b.x + b.width &&
        a.x + a.width > b.x &&
        a.y < b.y + b.height &&
        a.y + a.height > b.y
      );
    }

    function spawnBottles() {
      bottles = [];
      const w = 2700;
      const h = 2700;

      const roadRect = {
        x: w / 2 - 200,
        y: 0,
        width: 400,
        height: h,
      };

      function randomPoint() {
        const x = Math.random() * (roadRect.width - 80) + roadRect.x + 40;
        const y = Math.random() * (roadRect.height - 80) + roadRect.y + 40;
        return { x, y };
      }

      const count = 18;

      for (let i = 0; i < count; i++) {
        const p = randomPoint();
        bottles.push({
          x: p.x,
          y: p.y,
          size: 52,
        });
      }
    }

    function resetPlayer() {
      player.size = 64;
      player.x = 2700 / 2;
      player.y = 2700 / 2 + 260;
      player.vx = 0;
      player.vy = 0;
      player.dir = 0;
      player.isMoving = false;
      player.frame = 1;
      player.frameTime = 0;
    }

    let joyActive = false;
    let joyCenter = { x: 0, y: 0 };
    let joyRadius = 0;

    function updateJoyLayout() {
      const rect = joyBase.getBoundingClientRect();
      joyCenter.x = rect.left + rect.width / 2;
      joyCenter.y = rect.top + rect.height / 2;
      joyRadius = rect.width * 0.5 * 0.7;
    }

    updateJoyLayout();
    window.addEventListener('resize', updateJoyLayout);

    function joyStart(x, y) {
      joyActive = true;
      joyMove(x, y);
    }

    function joyMove(x, y) {
      if (!joyActive) return;
      const dx = x - joyCenter.x;
      const dy = y - joyCenter.y;
      const dist = Math.sqrt(dx * dx + dy * dy) || 1;

      const clamped = Math.min(dist, joyRadius);
      const nx = (dx / dist) * clamped;
      const ny = (dy / dist) * clamped;

      joyKnob.style.transform =
        `translate(calc(-50% + ${nx}px), calc(-50% + ${ny}px))`;

      const vx = dx / dist;
      const vy = dy / dist;

      const len = Math.sqrt(vx * vx + vy * vy);
      if (len > 0.2) {
        const k = 1 / len;
        player.vx = vx * k;
        player.vy = vy * k;
        player.isMoving = true;

        if (Math.abs(vx) > Math.abs(vy)) {
          player.dir = vx > 0 ? 1 : 2;
        } else {
          player.dir = vy > 0 ? 0 : 3;
        }
      } else {
        player.vx = 0;
        player.vy = 0;
        player.isMoving = false;
      }
    }

    function joyEnd() {
      joyActive = false;
      player.vx = 0;
      player.vy = 0;
      player.isMoving = false;
      joyKnob.style.transform = 'translate(-50%, -50%)';
    }

    joyBase.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const t = e.changedTouches[0];
      joyStart(t.clientX, t.clientY);
    });

    joyBase.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const t = e.changedTouches[0];
      joyMove(t.clientX, t.clientY);
    });

    joyBase.addEventListener('touchend', (e) => {
      e.preventDefault();
      joyEnd();
    });

    joyBase.addEventListener('mousedown', (e) => {
      e.preventDefault();
      joyStart(e.clientX, e.clientY);
    });

    window.addEventListener('mousemove', (e) => {
      if (!joyActive) return;
      e.preventDefault();
      joyMove(e.clientX, e.clientY);
    });

    window.addEventListener('mouseup', (e) => {
      if (!joyActive) return;
      e.preventDefault();
      joyEnd();
    });

    function startGame() {
      timeLeft = GAME_TIME;
      score = 0;
      scoreEl.textContent = score;
      running = true;
      centerMessage.textContent = '';
      startBtn.style.display = 'none';

      resetPlayer();
      spawnBottles();
    }

    startBtn.addEventListener('click', startGame);

    function update(dt) {
      if (!running) return;

      timeLeft -= dt;
      if (timeLeft <= 0) {
        timeLeft = 0;
        running = false;
        centerMessage.textContent = `–í—Ä–µ–º—è –≤—ã—à–ª–æ! –°–æ–±—Ä–∞–Ω–æ: ${score}`;
        startBtn.style.display = 'block';
      }

      timeEl.textContent = `${Math.ceil(timeLeft)} s`;
      let vx = player.vx * player.speed * dt;
      let vy = player.vy * player.speed * dt;

      const half = player.size / 2;

      const newRect = {
        x: player.x - half + vx,
        y: player.y - half + vy,
        width: player.size,
        height: player.size,
      };

      for (const ob of obstacles) {
        const obRect = {
          x: ob.x,
          y: ob.y,
          width: ob.width,
          height: ob.height,
        };

        if (rectsOverlap(newRect, obRect)) {
          vx = 0;
          vy = 0;
          break;
        }
      }

      player.x += vx;
      player.y += vy;

      player.x = Math.max(half, Math.min(2700 - half, player.x));
      player.y = Math.max(half, Math.min(2700 - half, player.y));

      if (player.isMoving && (player.vx !== 0 || player.vy !== 0)) {
        player.frameTime += dt;
        if (player.frameTime >= player.frameDuration) {
          player.frameTime -= player.frameDuration;
          player.frame = (player.frame + 1) % sprite.cols;
        }
      } else {
        player.frame = 1;
        player.frameTime = 0;
      }

      const collectRadius = 42;

      bottles = bottles.filter(b => {
        const dx = b.x - player.x;
        const dy = b.y - player.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < collectRadius) {
          score++;
          scoreEl.textContent = score;
          return false;
        }
        return true;
      });

      if (bottles.length < 8) {
        spawnBottles();
      }
    }

    function draw() {
      const w = canvas.width;
      const h = canvas.height;

      ctx.clearRect(0, 0, w, h);

      const scale = Math.min(w / 2700, h / 2700);
      const viewW = w / scale;
      const viewH = h / scale;

      const halfViewW = viewW / 2;
      const halfViewH = viewH / 2;

      let camX = player.x;
      let camY = player.y;

      const margin = 220;
      if (camX < margin) camX = margin;
      if (camY < margin) camY = margin;
      if (camX > 2700 - margin) camX = 2700 - margin;
      if (camY > 2700 - margin) camY = 2700 - margin;

      let viewX = camX - halfViewW;
      let viewY = camY - halfViewH;

      if (viewX < 0) viewX = 0;
      if (viewY < 0) viewY = 0;
      if (viewX + viewW > 2700) viewX = 2700 - viewW;
      if (viewY + viewH > 2700) viewY = 2700 - viewH;

      ctx.save();
      ctx.scale(scale, scale);
      ctx.translate(-viewX, -viewY);

      // –∫–∞—Ä—Ç–∞ –∏–ª–∏ –∑–µ–ª—ë–Ω—ã–π —Ñ–æ–Ω
      if (mapImg.complete && mapImg.naturalWidth) {
        ctx.drawImage(mapImg, 0, 0, 2700, 2700);
      } else {
        ctx.fillStyle = '#3c6';
        ctx.fillRect(0, 0, 2700, 2700);
      }

      // –±—É—Ç—ã–ª–∫–∏
      for (const b of bottles) {
        if (bottleImg.complete && bottleImg.naturalWidth) {
          const s = b.size;
          ctx.drawImage(
            bottleImg,
            b.x - s / 2,
            b.y - s / 2,
            s, s
          );
        } else {
          ctx.fillStyle = '#fff';
          ctx.beginPath();
          ctx.arc(b.x, b.y, b.size / 2, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
      for (const ob of obstacles) {
        let img = null;
        if (ob.type === 'top') img = obstacleTopImg;
        else if (ob.type === 'bottom') img = obstacleBottomImg;

        if (img && img.complete && img.naturalWidth) {
          ctx.drawImage(img, ob.x, ob.y, ob.width, ob.height);
        } else {
          ctx.fillStyle = 'rgba(0,0,0,0.05)';
          ctx.fillRect(ob.x, ob.y, ob.width, ob.height);
        }
      }

      // –∏–≥—Ä–æ–∫
      if (playerImg.complete && playerImg.naturalWidth) {
        if (!sprite.frameW || !sprite.frameH) {
          sprite.frameW = playerImg.naturalWidth / sprite.cols;
          sprite.frameH = playerImg.naturalHeight / sprite.rows;
        }

        const row = player.dir;
        const col = player.frame;

        const sx = col * sprite.frameW;
        const sy = row * sprite.frameH;

        const px = player.x - player.size / 2;
        const py = player.y - player.size / 2;

        ctx.drawImage(
          playerImg,
          sx, sy, sprite.frameW, sprite.frameH,
          px, py, player.size, player.size
        );
      } else {
        ctx.fillStyle = '#ffd54f';
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.size / 2, 0, Math.PI * 2);
        ctx.fill();
      }

      ctx.restore();
    }

    createObstacles();
    resetPlayer();
    spawnBottles();

    function loop(ts) {
      if (!lastTs) lastTs = ts;
      const dt = (ts - lastTs) / 1000;
      lastTs = ts;

      update(dt);
      draw();

      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  </script>
</body>
</html>