
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Gypsy Bottle Game - 30 —Å–µ–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }

    #gameWrapper {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #000;
    }

    #hud {
      position: absolute;
      top: 8px;
      left: 10px;
      z-index: 3;
      padding: 4px 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      color: #f8f8f8;
      text-shadow: 0 0 4px #000;
    }

    #hud span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #gameCanvas {
      flex: 1;
      display: block;
      width: 100%;
      height: 100%;
      background: url("assets/city-map.png") center / cover no-repeat, #222;
      touch-action: none;
    }

    #startBtn {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      padding: 10px 22px;
      border-radius: 999px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #ffd54f, #ff9100);
      color: #222;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
      z-index: 4;
    }

    #startBtn:active {
      transform: translate(-50%, -50%) scale(0.97);
    }

    #centerMessage {
      position: absolute;
      left: 50%;
      top: 40%;
      transform: translateX(-50%);
      color: #fff;
      font-size: 20px;
      text-align: center;
      text-shadow: 0 0 6px #000;
      z-index: 3;
      padding: 0 12px;
      pointer-events: none;
    }

    #controls {
      position: absolute;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      width: min(340px, 80vw);
      display: flex;
      justify-content: center;
      z-index: 3;
    }

    .stick-wrapper {
      position: relative;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: radial-gradient(circle, #222 0, #000 70%);
      box-shadow: 0 0 12px rgba(0,0,0,0.7);
      border: 2px solid rgba(255,255,255,0.1);
      touch-action: none;
    }

    .stick-inner {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 72px;
      height: 72px;
      margin-left: -36px;
      margin-top: -36px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffeb3b, #ff9100);
      box-shadow: 0 0 18px rgba(0,0,0,0.8);
      touch-action: none;
    }

    #infoBanner {
      position: absolute;
      bottom: 210px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.65);
      color: #fff;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      z-index: 3;
      display: none;
      backdrop-filter: blur(6px);
    }

    @media (min-width: 768px) {
      #hud {
        font-size: 20px;
      }
      .stick-wrapper {
        width: 200px;
        height: 200px;
      }
      .stick-inner {
        width: 80px;
        height: 80px;
        margin-left: -40px;
        margin-top: -40px;
      }
    }
  </style>
</head>
<body>
<div id="gameWrapper">
  <canvas id="gameCanvas"></canvas>

  <div id="hud">
    <span><span id="time">30</span>s</span>
    <span>üçæ <span id="score">0</span></span>
  </div>

  <button id="startBtn">–ò–≥—Ä–∞—Ç—å 30 —Å–µ–∫</button>
  <div id="centerMessage"></div>
  <div id="infoBanner">–î–≤–∏–≥–∞–π –∫—Ä—É–≥ –¥–∂–æ–π—Å—Ç–∏–∫–∞, —á—Ç–æ–±—ã –∏–¥—Ç–∏</div>

  <div id="controls">
    <div class="stick-wrapper" id="stickWrapper">
      <div class="stick-inner" id="stickInner"></div>
    </div>
  </div>
</div>

<script>
  const GAME_TIME = 30;
  const PLAYER_SPEED = 220;
  const PLAYER_SIZE = 60;
  const BOTTLE_SIZE = 40;
  const BOTTLE_SPAWN_INTERVAL = 700;
  const MAX_BOTTLES = 10;

  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const timeEl = document.getElementById("time");
  const scoreEl = document.getElementById("score");
  const startBtn = document.getElementById("startBtn");
  const centerMessage = document.getElementById("centerMessage");
  const infoBanner = document.getElementById("infoBanner");

  const stickWrapper = document.getElementById("stickWrapper");
  const stickInner = document.getElementById("stickInner");

  let cw = 0, ch = 0;

  let player = { x: 0, y: 0, size: PLAYER_SIZE };
  let bottles = [];
  let score = 0;
  let gameTimeLeft = GAME_TIME;
  let isRunning = false;
  let lastTimestamp = 0;
  let spawnTimer = 0;

  let moveVector = { x: 0, y: 0 };

  const playerImg = new Image();
  playerImg.src = "assets/gypsy.png";

  const bottleImg = new Image();
  bottleImg.src = "assets/bottle.png";

  function resize() {
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    cw = canvas.width;
    ch = canvas.height;

    player.x = cw / 2;
    player.y = ch / 2;
  }

  window.addEventListener("resize", resize);
  resize();

  let stickActive = false;
  let stickCenter = { x: 0, y: 0 };

  function getTouchPos(touch) {
    const rect = stickWrapper.getBoundingClientRect();
    return {
      x: touch.clientX - rect.left,
      y: touch.clientY - rect.top
    };
  }

  function updateStick(dx, dy) {
    const maxRadius = stickWrapper.clientWidth / 2 - stickInner.clientWidth / 2;
    const dist = Math.sqrt(dx * dx + dy * dy);
    let clampedX = dx;
    let clampedY = dy;

    if (dist > maxRadius) {
      const k = maxRadius / dist;
      clampedX *= k;
      clampedY *= k;
    }

    stickInner.style.transform = "translate(" + clampedX + "px," + clampedY + "px)";
    moveVector.x = clampedX / maxRadius;
    moveVector.y = clampedY / maxRadius;
  }

  function resetStick() {
    stickInner.style.transform = "translate(0px,0px)";
    moveVector.x = 0;
    moveVector.y = 0;
  }

  stickWrapper.addEventListener("touchstart", (e) => {
    e.preventDefault();
    stickActive = true;
    infoBanner.style.display = "none";

    const rect = stickWrapper.getBoundingClientRect();
    stickCenter.x = rect.width / 2;
    stickCenter.y = rect.height / 2;

    const touch = e.changedTouches[0];
    const pos = getTouchPos(touch);
    updateStick(pos.x - stickCenter.x, pos.y - stickCenter.y);
  }, { passive: false });

  stickWrapper.addEventListener("touchmove", (e) => {
    e.preventDefault();
    if (!stickActive) return;
    const touch = e.changedTouches[0];
    const pos = getTouchPos(touch);
    updateStick(pos.x - stickCenter.x, pos.y - stickCenter.y);
  }, { passive: false });

  stickWrapper.addEventListener("touchend", (e) => {
    e.preventDefault();
    stickActive = false;
    resetStick();
  }, { passive: false });

  stickWrapper.addEventListener("mousedown", (e) => {
    e.preventDefault();
    stickActive = true;
    infoBanner.style.display = "none";
    const rect = stickWrapper.getBoundingClientRect();
    stickCenter.x = rect.width / 2;
    stickCenter.y = rect.height / 2;
    const dx = e.clientX - rect.left - stickCenter.x;
    const dy = e.clientY - rect.top - stickCenter.y;
    updateStick(dx, dy);
  });

  window.addEventListener("mousemove", (e) => {
    if (!stickActive) return;
    const rect = stickWrapper.getBoundingClientRect();
    const dx = e.clientX - rect.left - stickCenter.x;
    const dy = e.clientY - rect.top - stickCenter.y;
    updateStick(dx, dy);
  });

  window.addEventListener("mouseup", () => {
    if (!stickActive) return;
    stickActive = false;
    resetStick();
  });

  function spawnBottle() {
    if (bottles.length >= MAX_BOTTLES) return;
    const margin = 30;
    const x = margin + Math.random() * (cw - margin * 2);
    const y = margin + Math.random() * (ch - margin * 2);
    bottles.push({ x, y, size: BOTTLE_SIZE });
  }

  function resetGame() {
    score = 0;
    bottles = [];
    gameTimeLeft = GAME_TIME;
    spawnTimer = 0;
    timeEl.textContent = GAME_TIME.toString();
    scoreEl.textContent = "0";
    centerMessage.textContent = "";
  }

  startBtn.addEventListener("click", () => {
    resetGame();
    isRunning = true;
    startBtn.style.display = "none";
    infoBanner.style.display = "block";
  });

  function update(dt) {
    if (!isRunning) return;

    gameTimeLeft -= dt;
    if (gameTimeLeft <= 0) {
      gameTimeLeft = 0;
      isRunning = false;
      centerMessage.innerHTML = "‚è≥ –í—Ä–µ–º—è –≤—ã—à–ª–æ!<br>–¢—ã —Å–æ–±—Ä–∞–ª: <b>" + score + "</b> –±—É—Ç—ã–ª–æ–∫";
      startBtn.textContent = "–ò–≥—Ä–∞—Ç—å –µ—â—ë 30 —Å–µ–∫";
      startBtn.style.display = "block";
    }
    timeEl.textContent = Math.ceil(gameTimeLeft).toString();

    const len = Math.hypot(moveVector.x, moveVector.y);
    let vx = 0, vy = 0;
    if (len > 0.1) {
      vx = (moveVector.x / len) * PLAYER_SPEED;
      vy = (moveVector.y / len) * PLAYER_SPEED;
    }

    player.x += vx * dt;
    player.y += vy * dt;

    const half = player.size / 2;
    if (player.x < half) player.x = half;
    if (player.x > cw - half) player.x = cw - half;
    if (player.y < half) player.y = half;
    if (player.y > ch - half) player.y = ch - half;

    spawnTimer += dt * 1000;
    if (spawnTimer >= BOTTLE_SPAWN_INTERVAL) {
      spawnTimer = 0;
      spawnBottle();
    }

    for (let i = bottles.length - 1; i >= 0; i--) {
      const b = bottles[i];
      const dx = player.x - b.x;
      const dy = player.y - b.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < (player.size/2 + b.size/2) * 0.85) {
        bottles.splice(i, 1);
        score++;
        scoreEl.textContent = score.toString();
      }
    }
  }

  function draw() {
    ctx.clearRect(0, 0, cw, ch);

    bottles.forEach(b => {
      if (bottleImg.complete && bottleImg.naturalWidth > 0) {
        ctx.drawImage(bottleImg, b.x - b.size/2, b.y - b.size/2, b.size, b.size);
      } else {
        ctx.fillStyle = "#aee";
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.size/2, 0, Math.PI*2);
        ctx.fill();
      }
    });

    const ps = player.size;
    if (playerImg.complete && playerImg.naturalWidth > 0) {
      ctx.drawImage(playerImg, player.x - ps/2, player.y - ps/2, ps, ps);
    } else {
      ctx.fillStyle = "#ffd54f";
      ctx.beginPath();
      ctx.arc(player.x, player.y, ps/2, 0, Math.PI*2);
      ctx.fill();
    }
  }

  function gameLoop(timestamp) {
    if (!lastTimestamp) lastTimestamp = timestamp;
    const dt = (timestamp - lastTimestamp) / 1000;
    lastTimestamp = timestamp;

    update(dt);
    draw();

    requestAnimationFrame(gameLoop);
  }

  requestAnimationFrame(gameLoop);
</script>
</body>
</html>
