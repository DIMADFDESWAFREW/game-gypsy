
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Gypsy Bottle Game - 30 —Å–µ–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #111;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }

    #gameWrapper {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #333 0, #000 55%, #000 100%);
    }

    #hud {
      position: relative;
      z-index: 2;
      padding: 8px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      color: #f8f8f8;
      text-shadow: 0 0 4px #000;
    }

    #hud span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #hud-label {
      font-size: 13px;
      opacity: 0.8;
    }

    #gameCanvas {
      flex: 1;
      display: block;
      background: url("city-map.jpg") center / cover no-repeat, #222;
      touch-action: none;
    }

    /* –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ä—Ç/—Ä–µ—Å—Ç–∞—Ä—Ç */
    #startBtn {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      padding: 12px 22px;
      border-radius: 999px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #ffd54f, #ff9100);
      color: #222;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
      z-index: 3;
    }

    #startBtn:active {
      transform: translate(-50%, -50%) scale(0.97);
    }

    /* –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É */
    #centerMessage {
      position: absolute;
      left: 50%;
      top: 42%;
      transform: translateX(-50%);
      color: #fff;
      font-size: 20px;
      text-align: center;
      text-shadow: 0 0 6px #000;
      z-index: 3;
      padding: 0 12px;
      pointer-events: none;
    }

    /* –°–µ–Ω—Å–æ—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–¥–∂–æ–π—Å—Ç–∏–∫) */
    #controls {
      position: absolute;
      left: 50%;
      bottom: 12px;
      transform: translateX(-50%);
      width: min(340px, 80vw);
      display: flex;
      justify-content: center;
      z-index: 3;
    }

    .stick-wrapper {
      position: relative;
      width: 180px;  /* —É–≤–µ–ª–∏—á–µ–Ω–æ ~—Ö1.5 */
      height: 180px;
      border-radius: 50%;
      background: radial-gradient(circle, #222 0, #000 70%);
      box-shadow: 0 0 12px rgba(0,0,0,0.7);
      border: 2px solid rgba(255,255,255,0.08);
      touch-action: none;
    }

    .stick-inner {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 72px;
      height: 72px;
      margin-left: -36px;
      margin-top: -36px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffeb3b, #ff9100);
      box-shadow: 0 0 18px rgba(0,0,0,0.8);
      touch-action: none;
    }

    #infoBanner {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.65);
      color: #fff;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      z-index: 3;
      display: none;
      backdrop-filter: blur(6px);
    }

    @media (min-width: 768px) {
      #hud {
        font-size: 18px;
      }
      #centerMessage {
        font-size: 22px;
      }
      .stick-wrapper {
        width: 200px;
        height: 200px;
      }
      .stick-inner {
        width: 80px;
        height: 80px;
        margin-left: -40px;
        margin-top: -40px;
      }
    }
  </style>
</head>
<body>
<div id="gameWrapper">
  <div id="hud">
    <span>
      <span id="hud-label">‚è± –í—Ä–µ–º—è:</span>
      <strong id="time">30</strong> c
    </span>
    <span>
      <span id="hud-label">üçæ –ë–∞–ª–∞–Ω—Å:</span>
      <strong id="score">0</strong>
    </span>
  </div>

  <canvas id="gameCanvas"></canvas>

  <button id="startBtn">–ò–≥—Ä–∞—Ç—å 30 —Å–µ–∫</button>
  <div id="centerMessage"></div>
  <div id="infoBanner">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –¥–≤–∏–≥–∞–π –∫—Ä—É–≥ –¥–∂–æ–π—Å—Ç–∏–∫–∞</div>

  <div id="controls">
    <div class="stick-wrapper" id="stickWrapper">
      <div class="stick-inner" id="stickInner"></div>
    </div>
  </div>
</div>

<script>
  // ================== –ù–ê–°–¢–†–û–ô–ö–ò –ò–ì–†–´ ==================
  const GAME_TIME = 30; // —Å–µ–∫—É–Ω–¥
  const PLAYER_SPEED = 210; // –ø–∏–∫—Å–µ–ª–µ–π –≤ —Å–µ–∫—É–Ω–¥—É
  const BOTTLE_SPAWN_INTERVAL = 700; // ms, —á–∞—Å—Ç–æ —Å–ø–∞–≤–Ω–∏–º –±—É—Ç—ã–ª–∫–∏
  const MAX_BOTTLES = 12;
  const BOTTLE_SIZE = 32; // –º–∞–ª–µ–Ω—å–∫–∞—è –±—É—Ç—ã–ª–∫–∞ (—á–µ—Ä–µ–∑ —Å–ø—Ä–∞–π—Ç)
  const PLAYER_SIZE = 40;

  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const timeEl = document.getElementById("time");
  const scoreEl = document.getElementById("score");
  const startBtn = document.getElementById("startBtn");
  const centerMessage = document.getElementById("centerMessage");
  const infoBanner = document.getElementById("infoBanner");

  const stickWrapper = document.getElementById("stickWrapper");
  const stickInner = document.getElementById("stickInner");

  let cw = 0, ch = 0;

  // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  let player = {
    x: 0,
    y: 0,
    size: PLAYER_SIZE,
  };

  let bottles = [];
  let score = 0;
  let gameTimeLeft = GAME_TIME;
  let lastTimestamp = 0;
  let isRunning = false;
  let spawnTimer = 0;

  // –í–µ–∫—Ç–æ—Ä –¥–≤–∏–∂–µ–Ω–∏—è –æ—Ç –¥–∂–æ–π—Å—Ç–∏–∫–∞
  let moveVector = { x: 0, y: 0 };

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–π—Ç–æ–≤ (–ø–µ—Ä—Å–æ–Ω–∞–∂ –∏ –±—É—Ç—ã–ª–∫–∞)
  const playerImg = new Image();
  // –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏–≥—Ä–æ–∫–∞ - —Å—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤—å —Å–≤–æ–π —Ñ–∞–π–ª, –ª–µ–∂–∞—â–∏–π —Ä—è–¥–æ–º —Å html
  playerImg.src = "player.png";

  const bottleImg = new Image();
  // –±—É—Ç—ã–ª–∫–∞ –∏–≥—Ä–æ–∫–∞ - png, —É–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –≤ 3 —Ä–∞–∑–∞
  bottleImg.src = "bottle.png";

  // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞–Ω–≤–∞—Å–∞ –ø–æ–¥ —ç–∫—Ä–∞–Ω
  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - document.getElementById("hud").offsetHeight;
    cw = canvas.width;
    ch = canvas.height;

    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    player.x = cw / 2;
    player.y = ch / 2;
  }

  window.addEventListener("resize", resize);
  resize();

  // ======== –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ñ–û–ô–°–¢–ò–ö–û–ú (—Ç–∞—á) =========
  let stickActive = false;
  let stickCenter = { x: 0, y: 0 };

  function getTouchPos(touch) {
    const rect = stickWrapper.getBoundingClientRect();
    return {
      x: touch.clientX - rect.left,
      y: touch.clientY - rect.top
    };
  }

  function updateStick(dx, dy) {
    const maxRadius = stickWrapper.clientWidth / 2 - stickInner.clientWidth / 2;
    const dist = Math.sqrt(dx * dx + dy * dy);
    let clampedX = dx;
    let clampedY = dy;

    if (dist > maxRadius) {
      const k = maxRadius / dist;
      clampedX *= k;
      clampedY *= k;
    }

    stickInner.style.transform =
      `translate(${clampedX}px, ${clampedY}px)`;

    // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –≤–µ–∫—Ç–æ—Ä [-1 .. 1]
    moveVector.x = clampedX / maxRadius;
    moveVector.y = clampedY / maxRadius;
  }

  function resetStick() {
    stickInner.style.transform = "translate(0px, 0px)";
    moveVector.x = 0;
    moveVector.y = 0;
  }

  stickWrapper.addEventListener("touchstart", (e) => {
    e.preventDefault();
    stickActive = true;
    infoBanner.style.display = "none";

    const touch = e.changedTouches[0];
    const rect = stickWrapper.getBoundingClientRect();
    stickCenter.x = rect.width / 2;
    stickCenter.y = rect.height / 2;

    const pos = getTouchPos(touch);
    updateStick(pos.x - stickCenter.x, pos.y - stickCenter.y);
  }, { passive: false });

  stickWrapper.addEventListener("touchmove", (e) => {
    e.preventDefault();
    if (!stickActive) return;
    const touch = e.changedTouches[0];
    const pos = getTouchPos(touch);
    updateStick(pos.x - stickCenter.x, pos.y - stickCenter.y);
  }, { passive: false });

  stickWrapper.addEventListener("touchend", (e) => {
    e.preventDefault();
    stickActive = false;
    resetStick();
  }, { passive: false });

  // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º—ã—à–∏ (–¥–ª—è —Ç–µ—Å—Ç–∞ –Ω–∞ –ü–ö)
  stickWrapper.addEventListener("mousedown", (e) => {
    e.preventDefault();
    stickActive = true;
    infoBanner.style.display = "none";

    const rect = stickWrapper.getBoundingClientRect();
    stickCenter.x = rect.width / 2;
    stickCenter.y = rect.height / 2;
    const dx = e.clientX - rect.left - stickCenter.x;
    const dy = e.clientY - rect.top - stickCenter.y;
    updateStick(dx, dy);
  });

  window.addEventListener("mousemove", (e) => {
    if (!stickActive) return;
    const rect = stickWrapper.getBoundingClientRect();
    const dx = e.clientX - rect.left - stickCenter.x;
    const dy = e.clientY - rect.top - stickCenter.y;
    updateStick(dx, dy);
  });

  window.addEventListener("mouseup", () => {
    if (!stickActive) return;
    stickActive = false;
    resetStick();
  });

  // ========= –õ–û–ì–ò–ö–ê –°–ü–ê–í–ù–ê –ë–£–¢–´–õ–û–ö =========
  function spawnBottle() {
    if (bottles.length >= MAX_BOTTLES) return;
    const margin = 24;
    const x = margin + Math.random() * (cw - margin * 2);
    const y = margin + Math.random() * (ch - margin * 2);

    bottles.push({
      x,
      y,
      size: BOTTLE_SIZE
    });
  }

  // ========= –°–¢–ê–†–¢ / –†–ï–°–¢–ê–†–¢ –ò–ì–†–´ =========
  function resetGame() {
    score = 0;
    gameTimeLeft = GAME_TIME;
    bottles = [];
    spawnTimer = 0;
    lastTimestamp = 0;
    timeEl.textContent = gameTimeLeft.toString();
    scoreEl.textContent = score.toString();
    centerMessage.textContent = "";
  }

  startBtn.addEventListener("click", () => {
    resetGame();
    isRunning = true;
    startBtn.style.display = "none";
    infoBanner.style.display = "block";
  });

  // ========= –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ =========
  function update(dt) {
    if (!isRunning) return;

    // –í—Ä–µ–º—è
    gameTimeLeft -= dt;
    if (gameTimeLeft <= 0) {
      gameTimeLeft = 0;
      isRunning = false;
      centerMessage.innerHTML = "‚è≥ –í—Ä–µ–º—è –≤—ã—à–ª–æ!<br>–¢—ã —Å–æ–±—Ä–∞–ª: <b>" + score + "</b> –±—É—Ç—ã–ª–æ–∫";
      startBtn.textContent = "–ò–≥—Ä–∞—Ç—å –µ—â—ë 30 —Å–µ–∫";
      startBtn.style.display = "block";
    }
    timeEl.textContent = Math.ceil(gameTimeLeft).toString();

    // –î–≤–∏–∂–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –æ—Ç –¥–∂–æ–π—Å—Ç–∏–∫–∞
    const len = Math.hypot(moveVector.x, moveVector.y);
    let vx = 0, vy = 0;
    if (len > 0.1) {
      vx = (moveVector.x / len) * PLAYER_SPEED;
      vy = (moveVector.y / len) * PLAYER_SPEED;
    }

    player.x += vx * dt;
    player.y += vy * dt;

    // –ì—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã
    const half = player.size / 2;
    if (player.x < half) player.x = half;
    if (player.x > cw - half) player.x = cw - half;
    if (player.y < half) player.y = half;
    if (player.y > ch - half) player.y = ch - half;

    // –°–ø–∞–≤–Ω –±—É—Ç—ã–ª–æ–∫
    spawnTimer += dt * 1000;
    if (spawnTimer >= BOTTLE_SPAWN_INTERVAL) {
      spawnTimer = 0;
      spawnBottle();
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å –±—É—Ç—ã–ª–∫–∞–º–∏
    for (let i = bottles.length - 1; i >= 0; i--) {
      const b = bottles[i];
      const dx = player.x - b.x;
      const dy = player.y - b.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < (player.size / 2 + b.size / 2) * 0.9) {
        // –°–æ–±—Ä–∞–ª–∏ –±—É—Ç—ã–ª–∫—É
        bottles.splice(i, 1);
        score += 1;
        scoreEl.textContent = score.toString();
      }
    }
  }

  function draw() {
    ctx.clearRect(0, 0, cw, ch);

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –±—É—Ç—ã–ª–æ–∫
    bottles.forEach(b => {
      const size = b.size;
      if (bottleImg.complete && bottleImg.naturalWidth > 0) {
        ctx.drawImage(bottleImg, b.x - size / 2, b.y - size / 2, size, size);
      } else {
        // –§–æ–ª–±–µ–∫, –µ—Å–ª–∏ –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏
        ctx.fillStyle = "#ffeb3b";
        ctx.beginPath();
        ctx.arc(b.x, b.y, size / 2, 0, Math.PI * 2);
        ctx.fill();
      }
    });

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    const ps = player.size;
    if (playerImg.complete && playerImg.naturalWidth > 0) {
      ctx.drawImage(playerImg, player.x - ps / 2, player.y - ps / 2, ps, ps);
    } else {
      ctx.fillStyle = "#ffd54f";
      ctx.beginPath();
      ctx.arc(player.x, player.y, ps / 2, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  function gameLoop(timestamp) {
    if (!lastTimestamp) lastTimestamp = timestamp;
    const dt = (timestamp - lastTimestamp) / 1000;
    lastTimestamp = timestamp;

    update(dt);
    draw();

    requestAnimationFrame(gameLoop);
  }

  requestAnimationFrame(gameLoop);
</script>
</body>
</html>
