
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Gypsy City Bottle Hunt</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<style>
  body {
    margin: 0;
    background: #000;
    overflow: hidden;
    touch-action: none;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  #game {
    width: 100vw;
    height: 100vh;
    display: block;
    background: #20232a;
  }
  .hud {
    position: fixed;
    top: 10px;
    left: 10px;
    color: #fff;
    font-size: 16px;
    text-shadow: 0 0 4px #000;
    z-index: 10;
  }
  .hud div { margin-bottom: 4px; }

  .joy {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.4);
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25), rgba(0,0,0,0.3));
    z-index: 10;
  }
  .joy-inner {
    position: absolute;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.85);
    left: 36px;
    top: 36px;
    transform: translateZ(0);
  }

  @media (min-width: 900px) {
    .joy { bottom: 40px; left: 40px; }
  }
</style>
</head>
<body>
<canvas id="game"></canvas>

<div class="hud">
  <div>Счёт: <span id="score">0</span></div>
  <div>Время: <span id="time">120</span> c</div>
</div>

<div class="joy">
  <div class="joy-inner" id="stick"></div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

// HUD
const scoreEl = document.getElementById("score");
const timeEl  = document.getElementById("time");

// Мир уменьшен в 2 раза
const WORLD_W = 2500;
const WORLD_H = 2500;

// Assets
const gypsyImg = new Image();
gypsyImg.src = "assets/gypsy.png";

const bottleImg = new Image();
bottleImg.src = "assets/bottle.png";

// Игрок
const player = {
  x: WORLD_W / 2,
  y: WORLD_H / 2,
  speed: 0.26,
};

// Анимация
const frameW = 64;
const frameH = 64;
let frame = 0;
let frameTimer = 0;
let dir = 0; // 0-вниз,1-вверх,2-влево,3-вправо

// Управление
let joyDX = 0, joyDY = 0;
const joy = document.querySelector(".joy");
const stick = document.getElementById("stick");
let joyActive = false;

function handleJoyTouch(e) {
  const rect = joy.getBoundingClientRect();
  const t = e.touches[0];
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + rect.height / 2;
  const x = t.clientX - cx;
  const y = t.clientY - cy;
  const dist = Math.hypot(x, y);
  const max = rect.width * 0.4;
  if (dist < 4) {
    joyDX = joyDY = 0;
    stick.style.left = "36px";
    stick.style.top  = "36px";
    return;
  }
  const nx = x / dist;
  const ny = y / dist;
  const cl = Math.min(dist, max);
  joyDX = nx * (cl / max);
  joyDY = ny * (cl / max);
  stick.style.left = (36 + joyDX * 30) + "px";
  stick.style.top  = (36 + joyDY * 30) + "px";
}

joy.addEventListener("touchstart", e => {
  joyActive = true;
  handleJoyTouch(e);
}, {passive:false});

joy.addEventListener("touchmove", e => {
  e.preventDefault();
  if (!joyActive) return;
  handleJoyTouch(e);
}, {passive:false});

joy.addEventListener("touchend", e => {
  joyActive = false;
  joyDX = joyDY = 0;
  stick.style.left = "36px";
  stick.style.top  = "36px";
}, {passive:false});

joy.addEventListener("touchcancel", e => {
  joyActive = false;
  joyDX = joyDY = 0;
  stick.style.left = "36px";
  stick.style.top  = "36px";
}, {passive:false});

// Клавиатура
const keys = {ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false};
document.addEventListener("keydown", e => {
  if (e.key in keys) keys[e.key] = true;
});
document.addEventListener("keyup", e => {
  if (e.key in keys) keys[e.key] = false;
});

// Препятствия: дома и дороги (простые прямоугольники)
const obstacles = [
  // Дома (кварталы)
  {x:200,  y:200,  w:350, h:220, type:"house"},
  {x:800,  y:250,  w:320, h:260, type:"house"},
  {x:1450, y:300,  w:380, h:230, type:"house"},
  {x:400,  y:900,  w:360, h:260, type:"house"},
  {x:1350, y:900,  w:420, h:260, type:"house"},
  {x:500,  y:1500, w:340, h:260, type:"house"},
  {x:1550, y:1500, w:360, h:260, type:"house"},

  // Дороги — серые полосы
  {x:0,    y:700,  w:WORLD_W, h:140, type:"road"},
  {x:0,    y:1350, w:WORLD_W, h:140, type:"road"},
  {x:650,  y:0,    w:140, h:WORLD_H, type:"road"},
  {x:1350, y:0,    w:140, h:WORLD_H, type:"road"},
];

function isBlocked(nx, ny) {
  // Коллайдер игрока как маленький квадрат
  const r = 20;
  const left = nx - r;
  const right = nx + r;
  const top = ny - r;
  const bottom = ny + r;
  for (const o of obstacles) {
    const oL = o.x;
    const oR = o.x + o.w;
    const oT = o.y;
    const oB = o.y + o.h;
    if (right > oL && left < oR && bottom > oT && top < oB) {
      // По дорогам можем ходить, по домам нет
      if (o.type === "house") return true;
    }
  }
  return false;
}

// Бутылки
let bottles = [];
let lastSpawn = 0;
const BOTTLE_LIFETIME = 5000;
const SPAWN_INTERVAL = 900;

// Игра
let score = 0;
let timeLeft = 120000;
let lastTime = performance.now();
let gameOver = false;

function spawnBottle() {
  // Спавним не внутри домов
  for (let i = 0; i < 20; i++) {
    const x = 80 + Math.random() * (WORLD_W - 160);
    const y = 80 + Math.random() * (WORLD_H - 160);
    if (!isBlocked(x, y)) {
      bottles.push({ x, y, spawn: performance.now() });
      break;
    }
  }
}

function update(dt, now) {
  if (gameOver) return;

  // Таймер
  timeLeft -= dt;
  if (timeLeft <= 0) {
    timeLeft = 0;
    gameOver = true;
  }
  timeEl.textContent = (timeLeft / 1000 | 0).toString();

  // Спавн бутылок
  if (now - lastSpawn > SPAWN_INTERVAL) {
    spawnBottle();
    lastSpawn = now;
  }

  // Движение
  let mx = joyDX;
  let my = joyDY;

  if (!joyActive) {
    if (keys.ArrowUp)    my -= 1;
    if (keys.ArrowDown)  my += 1;
    if (keys.ArrowLeft)  mx -= 1;
    if (keys.ArrowRight) mx += 1;
  }

  if (mx !== 0 || my !== 0) {
    const len = Math.hypot(mx, my);
    mx /= len;
    my /= len;

    let nx = player.x + mx * player.speed * dt;
    let ny = player.y + my * player.speed * dt;

    if (!isBlocked(nx, player.y)) player.x = nx;
    if (!isBlocked(player.x, ny)) player.y = ny;

    // Направление для анимации
    if (Math.abs(mx) > Math.abs(my)) {
      dir = mx > 0 ? 3 : 2; // вправо / влево
    } else {
      dir = my > 0 ? 0 : 1; // вниз / вверх
    }

    // Анимация ходьбы
    frameTimer += dt;
    if (frameTimer > 120) {
      frame = (frame + 1) % 3;
      frameTimer = 0;
    }
  } else {
    frame = 1; // средний кадр как idle
  }

  // Границы мира
  player.x = Math.min(Math.max(player.x, 30), WORLD_W - 30);
  player.y = Math.min(Math.max(player.y, 30), WORLD_H - 30);

  // Обновить бутылки
  bottles = bottles.filter(b => {
    if (now - b.spawn > BOTTLE_LIFETIME) return false;
    const dist = Math.hypot(player.x - b.x, player.y - b.y);
    if (dist < 45) {
      score++;
      scoreEl.textContent = score.toString();
      return false;
    }
    return true;
  });
}

function drawCityBackground(camX, camY) {
  // Фон — плита города
  ctx.fillStyle = "#20252f";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.translate(-camX, -camY);

  // Дороги
  for (const o of obstacles) {
    if (o.type === "road") {
      ctx.fillStyle = "#555b66";
      ctx.fillRect(o.x, o.y, o.w, o.h);

      // Разметка
      ctx.strokeStyle = "rgba(255,255,255,0.5)";
      ctx.setLineDash([12, 12]);
      ctx.lineWidth = 2;
      ctx.beginPath();
      if (o.w > o.h) {
        // горизонтальная
        const cy = o.y + o.h / 2;
        ctx.moveTo(o.x + 10, cy);
        ctx.lineTo(o.x + o.w - 10, cy);
      } else {
        // вертикальная
        const cx = o.x + o.w / 2;
        ctx.moveTo(cx, o.y + 10);
        ctx.lineTo(cx, o.y + o.h - 10);
      }
      ctx.stroke();
      ctx.setLineDash([]);
    }
  }

  // Дома
  for (const o of obstacles) {
    if (o.type === "house") {
      ctx.fillStyle = "#2f3b52";
      ctx.fillRect(o.x, o.y, o.w, o.h);
      ctx.strokeStyle = "rgba(0,0,0,0.4)";
      ctx.lineWidth = 3;
      ctx.strokeRect(o.x, o.y, o.w, o.h);

      // окна
      ctx.fillStyle = "rgba(255,227,115,0.9)";
      const cols = Math.max(2, Math.floor(o.w / 80));
      const rows = Math.max(2, Math.floor(o.h / 80));
      for (let i = 0; i < cols; i++) {
        for (let j = 0; j < rows; j++) {
          const wx = o.x + 20 + i * (o.w - 40) / (cols - 1);
          const wy = o.y + 20 + j * (o.h - 40) / (rows - 1);
          ctx.fillRect(wx - 8, wy - 8, 16, 16);
        }
      }
    }
  }

  ctx.restore();
}

function draw(now) {
  const camX = player.x - canvas.width / 2;
  const camY = player.y - canvas.height / 2;

  drawCityBackground(camX, camY);

  ctx.save();
  ctx.translate(-camX, -camY);

  // Бутылки
  bottles.forEach(b => {
    const w = bottleImg.width;
    const h = bottleImg.height;
    ctx.drawImage(bottleImg, b.x - w/2, b.y - h + 20);
  });

  // Игрок
  if (gypsyImg.complete) {
    ctx.drawImage(
      gypsyImg,
      frame * frameW,
      dir * frameH,
      frameW, frameH,
      player.x - frameW / 2,
      player.y - frameH / 2,
      frameW, frameH
    );
  } else {
    ctx.fillStyle = "white";
    ctx.beginPath();
    ctx.arc(player.x, player.y, 20, 0, Math.PI * 2);
    ctx.fill();
  }

  ctx.restore();

  if (gameOver) {
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#fff";
    ctx.font = "28px system-ui";
    ctx.textAlign = "center";
    ctx.fillText("Игра окончена", canvas.width/2, canvas.height/2 - 10);
    ctx.font = "22px system-ui";
    ctx.fillText("Собрано бутылок: " + score, canvas.width/2, canvas.height/2 + 24);
  }
}

function loop(now) {
  const dt = now - lastTime;
  lastTime = now;
  update(dt, now);
  draw(now);
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
