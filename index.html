<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Gypsy Bottle Game</title>
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
  />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      -webkit-user-select: none;
      user-select: none;
    }

    #gameWrapper {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #000;
      overflow: hidden;
    }

    #gameCanvas {
      width: 100%;
      height: 100%;
      display: block;
      background: #262626;
      touch-action: none;
    }

    #hud {
      position: absolute;
      top: 10px;
      left: 12px;
      right: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #fff;
      font-size: 18px;
      font-weight: 500;
      z-index: 5;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
      pointer-events: none;
    }

    #startBtn {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      padding: 14px 32px;
      border-radius: 999px;
      border: none;
      font-size: 20px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #ffb12a, #ff7a00);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7);
      cursor: pointer;
      z-index: 6;
    }

    #startBtn:active {
      transform: translate(-50%, -50%) scale(0.97);
    }

    #centerMessage {
      position: absolute;
      left: 50%;
      top: 36%;
      transform: translateX(-50%);
      color: #fff;
      font-size: 20px;
      font-weight: 600;
      text-align: center;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9);
      z-index: 5;
      pointer-events: none;
    }

    #joystickBase {
      position: absolute;
      left: 50%;
      bottom: 26px;
      transform: translateX(-50%);
      width: 210px;
      height: 210px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #222, #000);
      border: 3px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 0 16px rgba(0, 0, 0, 0.85);
      z-index: 6;
      touch-action: none;
    }

    #joystickKnob {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 112px;
      height: 112px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      background: radial-gradient(circle at 30% 30%, #ffd86a, #ff9b00);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.8);
    }
  </style>
</head>

<body>
  <div id="gameWrapper">
    <canvas id="gameCanvas"></canvas>

    <div id="hud">
      <span><span id="time">30</span> s</span>
      <span>üçæ <span id="score">0</span></span>
    </div>

    <button id="startBtn">–ò–≥—Ä–∞—Ç—å 30 —Å–µ–∫</button>
    <div id="centerMessage"></div>

    <div id="joystickBase">
      <div id="joystickKnob"></div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resize);
    resize();

    const timeEl = document.getElementById("time");
    const scoreEl = document.getElementById("score");
    const startBtn = document.getElementById("startBtn");
    const centerMessage = document.getElementById("centerMessage");

    const joystickBase = document.getElementById("joystickBase");
    const joystickKnob = document.getElementById("joystickKnob");

    const mapImg = new Image();
    mapImg.src = "assets/city-map.png";

    const playerImg = new Image();
    playerImg.src = "assets/gypsy.png";

    const bottleImg = new Image();
    bottleImg.src = "assets/bottle.png";

    let assetsReady = false;
    let loadedCount = 0;
    [mapImg, playerImg, bottleImg].forEach((img) => {
      img.addEventListener("load", () => {
        loadedCount++;
        if (loadedCount === 3) {
          assetsReady = true;
        }
      });
    });

    const FRAME_W = 64;
    const FRAME_H = 64;
    const COLS = 3;

    const DIR_DOWN = 0;
    const DIR_LEFT = 1;
    const DIR_RIGHT = 2;
    const DIR_UP = 3;

    const player = {
      x: 0,
      y: 0,
      size: 80,
      speed: 180,
      dir: DIR_DOWN,
      frame: 1,
      frameTimer: 0,
      frameInterval: 0.12,
    };

    const bottles = [];
    const bottleRadius = 26;

    let gameRunning = false;
    let remaining = 30;
    let score = 0;

    let lastTs = 0;

    const JOY_MAX = 70;
    const JOY_DEAD = 6;
    let joyActive = false;
    let joyId = null;
    let joyDX = 0;
    let joyDY = 0;

    function setJoystickFromEvent(e) {
      const rect = joystickBase.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      const x = e.clientX - cx;
      const y = e.clientY - cy;

      const dist = Math.hypot(x, y);
      if (dist < JOY_DEAD) {
        joyDX = 0;
        joyDY = 0;
        joystickKnob.style.transform = "translate(-50%, -50%)";
        return;
      }

      const clamped = Math.min(dist, JOY_MAX);
      const nx = x / dist;
      const ny = y / dist;

      joyDX = nx;
      joyDY = ny;

      const knobOffset = (clamped / JOY_MAX) * 55;
      joystickKnob.style.transform = `translate(calc(-50% + ${
        nx * knobOffset
      }px), calc(-50% + ${ny * knobOffset}px))`;
    }

    joystickBase.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      joyActive = true;
      joyId = e.pointerId;
      joystickBase.setPointerCapture(joyId);
      setJoystickFromEvent(e);
    });

    joystickBase.addEventListener("pointermove", (e) => {
      if (!joyActive || e.pointerId !== joyId) return;
      e.preventDefault();
      setJoystickFromEvent(e);
    });

    joystickBase.addEventListener("pointerup", (e) => {
      if (e.pointerId !== joyId) return;
      joyActive = false;
      joyId = null;
      joyDX = 0;
      joyDY = 0;
      joystickKnob.style.transform = "translate(-50%, -50%)";
    });

    joystickBase.addEventListener("pointercancel", (e) => {
      if (e.pointerId !== joyId) return;
      joyActive = false;
      joyId = null;
      joyDX = 0;
      joyDY = 0;
      joystickKnob.style.transform = "translate(-50%, -50%)";
    });

    function resetPlayer() {
      player.x = canvas.width / 2;
      player.y = canvas.height / 2;
      player.dir = DIR_DOWN;
      player.frame = 1;
      player.frameTimer = 0;
    }

    function randomBottlePosition() {
      const padding = 40;
      return {
        x: padding + Math.random() * (canvas.width - padding * 2),
        y: padding + Math.random() * (canvas.height - padding * 2 - 140),
      };
    }

    function spawnInitialBottles() {
      bottles.length = 0;
      const count = 10;
      for (let i = 0; i < count; i++) {
        bottles.push(randomBottlePosition());
      }
    }

    function startGame() {
      if (!assetsReady) return;

      gameRunning = true;
      remaining = 30;
      score = 0;
      lastTs = 0;

      resetPlayer();
      spawnInitialBottles();

      timeEl.textContent = remaining.toString();
      scoreEl.textContent = "0";
      centerMessage.textContent = "";
      startBtn.style.display = "none";
    }

    startBtn.addEventListener("click", startGame);

    function update(dt) {
      if (!gameRunning) return;

      remaining -= dt;
      if (remaining <= 0) {
        remaining = 0;
        gameRunning = false;
        centerMessage.textContent = `–í—Ä–µ–º—è –≤—ã—à–ª–æ! –¢—ã —Å–æ–±—Ä–∞–ª ${score} üçæ`;
        startBtn.textContent = "–ò–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑";
        startBtn.style.display = "block";
      }
      timeEl.textContent = Math.ceil(remaining).toString();

      const moving = Math.abs(joyDX) + Math.abs(joyDY) > 0.01;

      if (moving) {
        const len = Math.hypot(joyDX, joyDY) || 1;
        const vx = (joyDX / len) * player.speed;
        const vy = (joyDY / len) * player.speed;

        player.x += vx * dt;
        player.y += vy * dt;

        const angle = Math.atan2(vy, vx);
        if (Math.abs(angle) < Math.PI / 4) {
          player.dir = DIR_RIGHT;
        } else if (Math.abs(angle) > (3 * Math.PI) / 4) {
          player.dir = DIR_LEFT;
        } else if (angle < 0) {
          player.dir = DIR_UP;
        } else {
          player.dir = DIR_DOWN;
        }

        player.frameTimer += dt;
        if (player.frameTimer >= player.frameInterval) {
          player.frameTimer = 0;
          player.frame = (player.frame + 1) % 3;
        }
      } else {
        player.frame = 1;
        player.frameTimer = 0;
      }

      const half = player.size / 2;
      if (player.x < half) player.x = half;
      if (player.x > canvas.width - half) player.x = canvas.width - half;
      if (player.y < half) player.y = half;
      if (player.y > canvas.height - half) player.y = canvas.height - half;

      for (let i = bottles.length - 1; i >= 0; i--) {
        const b = bottles[i];
        const dx = b.x - player.x;
        const dy = b.y - player.y;
        const dist = Math.hypot(dx, dy);
        if (dist < bottleRadius + half * 0.6) {
          bottles.splice(i, 1);
          score++;
          scoreEl.textContent = score.toString();
        }
      }

      while (bottles.length < 10) {
        bottles.push(randomBottlePosition());
      }
    }

    function drawBackground() {
      if (mapImg.complete && mapImg.naturalWidth > 0) {
        const sw = mapImg.naturalWidth;
        const sh = mapImg.naturalHeight;
        const scale = Math.max(
          canvas.width / sw,
          canvas.height / sh
        );

        const dw = sw * scale;
        const dh = sh * scale;
        const dx = (canvas.width - dw) / 2;
        const dy = (canvas.height - dh) / 2;

        ctx.drawImage(mapImg, 0, 0, sw, sh, dx, dy, dw, dh);
      } else {
        ctx.fillStyle = "#333";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }

    function drawPlayer() {
      if (playerImg.complete && playerImg.naturalWidth > 0) {
        const sx = player.frame * FRAME_W;
        const sy = player.dir * FRAME_H;
        const dx = player.x - player.size / 2;
        const dy = player.y - player.size / 2;
        ctx.drawImage(
          playerImg,
          sx,
          sy,
          FRAME_W,
          FRAME_H,
          dx,
          dy,
          player.size,
          player.size
        );
      } else {
        ctx.fillStyle = "#ffd54f";
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.size / 2, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function drawBottles() {
      bottles.forEach((b) => {
        if (bottleImg.complete && bottleImg.naturalWidth > 0) {
          const size = bottleRadius * 2;
          ctx.drawImage(
            bottleImg,
            b.x - size / 2,
            b.y - size / 2,
            size,
            size
          );
        } else {
          ctx.fillStyle = "#b3e5fc";
          ctx.beginPath();
          ctx.arc(b.x, b.y, bottleRadius, 0, Math.PI * 2);
          ctx.fill();
        }
      });
    }

    function draw(dt) {
      drawBackground();
      drawBottles();
      drawPlayer();
    }

    function loop(ts) {
      if (!lastTs) lastTs = ts;
      const dt = (ts - lastTs) / 1000;
      lastTs = ts;

      update(dt);
      draw(dt);

      requestAnimationFrame(loop);
    }

    requestAnimationFrame(loop);
  </script>
</body>
</html>